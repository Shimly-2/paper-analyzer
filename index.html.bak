<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paper Analyzer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg-primary:#121212;--bg-secondary:#1A1B1E;--bg-tertiary:#25262B;--border-color:#3A3C40;--accent:#9B7ED9;--text-primary:#FFFFFF;--text-secondary:#A0A0A0;--text-muted:#6B6B6B;--blue:#4A90D9;--orange:#E8A87C;--green:#7ED98E;--red:#C25D5D}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-secondary)}
::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
.top-nav{position:fixed;top:0;left:0;right:0;height:52px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.nav-left{display:flex;align-items:center;gap:16px}
.nav-logo{font-size:16px;font-weight:700;color:var(--accent)}
.nav-tabs{display:flex;gap:4px}
.nav-tab{padding:8px 16px;font-size:13px;color:var(--text-secondary);cursor:pointer;border-radius:6px;border:none;background:transparent}
.nav-tab.active{background:var(--accent);color:white}
.nav-right{display:flex;gap:8px}
.nav-btn{padding:7px 14px;font-size:12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);cursor:pointer}
.nav-btn.primary{background:var(--accent);border-color:var(--accent);color:white}
.container{display:flex;height:calc(100vh - 52px);margin-top:52px;position:relative}
.sidebar-left{width:300px;background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;transition:all .3s}
.sidebar-left.collapsed{width:0;overflow:hidden}
.sidebar-right{width:300px;background:var(--bg-secondary);border-left:1px solid var(--border-color);display:flex;flex-direction:column;transition:all .3s}
.sidebar-right.collapsed{width:0;overflow:hidden}
.toggle-btn{position:absolute;top:50%;transform:translateY(-50%);width:20px;height:40px;background:var(--bg-tertiary);border:1px solid var(--border-color);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-muted);z-index:10}
.toggle-left{left:300px;border-radius:0 6px 6px 0}
.toggle-left.collapsed{left:0}
.toggle-right{right:300px;border-radius:6px 0 0 6px}
.toggle-right.collapsed{right:0}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border-color)}
.search-input{width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:13px;margin-bottom:12px}
.filter-tags{display:flex;flex-wrap:wrap;gap:6px}
.filter-tag{padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid transparent}
.filter-tag.active{background:var(--blue);color:white}
.filter-tag:not(.active){background:var(--bg-tertiary);color:var(--text-secondary)}
.paper-list{flex:1;overflow-y:auto;padding:8px}
.paper-empty{padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px}
.paper-item{position:relative;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid transparent}
.paper-item:hover{background:var(--bg-tertiary)}
.paper-item.active{background:var(--bg-tertiary);border-color:var(--blue)}
.paper-delete{position:absolute;top:8px;right:8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:white;font-size:12px;display:none;align-items:center;justify-content:center;cursor:pointer;line-height:1}
.paper-item:hover .paper-delete{display:flex}
.paper-title{font-size:13px;font-weight:500;margin-bottom:4px;padding-right:20px}
.paper-meta{font-size:11px;color:var(--blue)}
.paper-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.paper-tag{padding:2px 6px;border-radius:3px;font-size:10px;background:var(--bg-primary);color:var(--text-muted)}
.paper-status{font-size:10px;margin-top:6px;color:var(--text-muted)}
.main-content{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.mode-tabs{display:flex;gap:4px;padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color)}
.mode-tab{padding:8px 20px;font-size:13px;color:var(--text-secondary);cursor:pointer;border-radius:6px;border:none;background:transparent}
.mode-tab.active{background:var(--accent);color:white}
.main-scroll{flex:1;overflow-y:auto;padding:20px}
.reading-container{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.reading-pane{background:var(--bg-secondary);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.pane-header{padding:12px 16px;background:var(--bg-tertiary);font-size:13px;font-weight:600;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.pane-content{flex:1;overflow-y:auto;padding:20px;font-size:14px;line-height:1.8}
.pane-content h1{font-size:20px;margin-bottom:16px}
.pane-content h2{font-size:16px;margin:20px 0 10px;color:var(--accent)}
.pane-content p{margin-bottom:12px;color:var(--text-secondary)}
.loading{display:inline-block;width:14px;height:14px;border:2px solid var(--border-color);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.analysis-header{margin-bottom:24px}
.analysis-title{font-size:22px;font-weight:700;margin-bottom:8px}
.analysis-meta{font-size:12px;color:var(--text-muted)}
.analysis-section{background:var(--bg-secondary);border-radius:12px;padding:20px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.section-dot{width:8px;height:8px;border-radius:50%}
.section-list{list-style:none}
.section-list li{font-size:13px;color:var(--text-secondary);margin-bottom:8px;padding-left:16px;position:relative}
.section-list li::before{content:"â€¢";position:absolute;left:0;color:var(--accent)}
.dimension-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
.dimension-card{border-radius:12px;padding:16px;min-height:180px}
.dimension-card.blue{background:linear-gradient(135deg,#1a3a5c,#0d1f33);border:1px solid #2a5a8c}
.dimension-card.orange{background:linear-gradient(135deg,#4a3520,#2d1f14);border:1px solid #8a5a30}
.dimension-card.green{background:linear-gradient(135deg,#1a4a30,#0d2a1c);border:1px solid #2a7a50}
.dimension-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.dimension-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center}
.dimension-card.blue .dimension-icon{background:var(--blue)}
.dimension-card.orange .dimension-icon{background:var(--orange)}
.dimension-card.green .dimension-icon{background:var(--green)}
.dimension-title{font-size:13px;font-weight:600}
.dimension-card.blue .dimension-title{color:var(--blue)}
.dimension-card.orange .dimension-title{color:var(--orange)}
.dimension-card.green .dimension-title{color:var(--green)}
.dimension-content{font-size:12px;color:var(--text-secondary);margin-bottom:12px}
.dimension-score{display:flex;align-items:center;gap:8px;padding-top:10px;border-top:1px solid rgba(255,255,255,.1)}
.score-badge{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}
.dimension-card.blue .score-badge{background:var(--blue);color:white}
.dimension-card.orange .score-badge{background:var(--orange);color:#1a1a1a}
.dimension-card.green .score-badge{background:var(--green);color:#1a1a1a}
.score-label{font-size:11px;color:var(--text-muted)}
.chat-header{padding:16px;border-bottom:1px solid var(--border-color)}
.chat-title{font-size:14px;font-weight:600}
.quick-questions{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;flex-direction:column;gap:8px}
.quick-btn{padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);font-size:12px;text-align:left;cursor:pointer}
.quick-btn:hover{background:var(--border-color)}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.chat-bubble{padding:12px 14px;background:var(--bg-tertiary);border-radius:10px;font-size:13px;color:var(--text-secondary)}
.chat-bubble.user{background:var(--accent);color:white;align-self:flex-end}
.chat-input-area{padding:16px;border-top:1px solid var(--border-color)}
.chat-input-wrapper{display:flex;gap:8px}
.chat-input{flex:1;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:13px}
.send-btn{padding:10px 16px;background:var(--accent);border:none;border-radius:8px;color:white;cursor:pointer}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:200}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-secondary);border-radius:12px;width:560px;max-width:90vw;border:1px solid var(--border-color);max-height:80vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between}
.modal-title{font-size:15px;font-weight:600}
.modal-close{cursor:pointer;color:var(--text-muted)}
.modal-body{padding:20px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:13px}
.form-textarea{min-height:100px;resize:vertical}
.form-file{width:100%;padding:20px;background:var(--bg-tertiary);border:2px dashed var(--border-color);border-radius:6px;text-align:center;cursor:pointer}
.form-file:hover{border-color:var(--accent)}
.form-file input{display:none}
.file-list{margin-top:12px}
.file-item{display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;font-size:12px}
.file-remove{cursor:pointer;color:var(--red)}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:8px}
.tag-input-wrapper{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.tag-input{flex:1;min-width:80px;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-primary);font-size:12px}
.tag-input:focus{border-color:var(--accent);outline:none}
.add-tag-btn{padding:6px 10px;background:var(--accent);border:none;border-radius:4px;color:white;font-size:11px;cursor:pointer}
.custom-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.custom-tag{display:flex;align-items:center;gap:4px;padding:3px 8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;font-size:11px;color:var(--text-secondary)}
.custom-tag span{cursor:pointer;color:var(--red)}
.mobile-nav{display:none}
@media(max-width:1200px){.dimension-cards{grid-template-columns:1fr}}
@media(max-width:1024px){.sidebar-right{display:none}}
@media(max-width:768px){
.container{height:auto;min-height:calc(100vh - 52px);flex-direction:column}
.sidebar-left{position:fixed;top:52px;left:0;bottom:60px;width:280px;z-index:50;transform:translateX(-100%);transition:transform .3s}
.sidebar-left.show{transform:translateX(0)}
.sidebar-left.collapsed{transform:translateX(-100%);width:280px}
.toggle-left{display:none}
.toggle-right{display:none}
.reading-container{grid-template-columns:1fr;gap:12px;padding:12px}
.reading-pane{min-height:300px}
.pane-content{padding:12px;font-size:13px}
.pane-header{padding:10px 12px;font-size:12px}
.nav-tabs{display:none}
.nav-right{padding-right:0}
.nav-btn{padding:6px 10px;font-size:11px}
.mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);padding:6px 0;z-index:100}
.mobile-nav-items{display:flex;justify-content:space-around;width:100%}
.mobile-item{display:flex;flex-direction:column;align-items:center;font-size:10px;color:var(--text-muted);cursor:pointer}
.mobile-item.active{color:var(--accent)}
.mobile-icon{font-size:22px;margin-bottom:2px}
.main-content{padding-bottom:70px}
.mode-tabs{padding:8px 12px;overflow-x:auto}
.mode-tab{padding:6px 14px;font-size:12px;white-space:nowrap}
.mobile-menu-btn{display:flex !important;width:32px;height:32px;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;color:var(--text-secondary)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;display:none}
.overlay.show{display:block}
}
</style>
</head>
<body>
<nav class="top-nav">
<div class="nav-left"><span class="nav-logo">Paper Analyzer</span>
<div class="nav-tabs"><button class="nav-tab active">è®ºæ–‡åº“</button><button class="nav-tab">é˜…è¯»æ¨¡å¼</button><button class="nav-tab">åˆ†ææŠ¥å‘Š</button></div>
</div>
<button class="mobile-menu-btn" onclick="toggleMobileSidebar()">â˜°</button><div class="nav-right"><button class="nav-btn" onclick="showAddPaperModal()">+ æ·»åŠ è®ºæ–‡</button><button class="nav-btn" onclick="clearAllPapers()">æ¸…ç©º</button><button class="nav-btn" onclick="showApiSettings()">API</button></div>
</nav>
<div class="overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div><div class="container">
<aside class="sidebar-left" id="sidebarLeft">
<div class="sidebar-header"><input type="text" class="search-input" placeholder="æœç´¢è®ºæ–‡..." id="paperSearch" oninput="renderPaperList()">
<div class="filter-tags"><span class="filter-tag active" onclick="setFilter('all')">å…¨éƒ¨</span><span class="filter-tag" onclick="setFilter('benchmark')">Benchmark</span><span class="filter-tag" onclick="setFilter('long')">é•¿æ–‡æœ¬</span><span class="filter-tag" onclick="setFilter('agent')">Agent</span></div>
</div>
<div class="paper-list" id="paperList"></div>
</aside>
<button class="toggle-btn toggle-left" id="toggleLeft" onclick="toggleSidebar('left')">&#8249;</button>
<main class="main-content">
<div class="mode-tabs"><button class="mode-tab active" onclick="switchMode('reading')">é˜…è¯»æ¨¡å¼</button><button class="mode-tab" onclick="switchMode('analysis')">åˆ†ææŠ¥å‘Š</button></div>
<div class="main-scroll">
<div id="readingMode">
<div class="reading-container">
<div class="reading-pane"><div class="pane-header"><span>åŸæ–‡</span><button class="paper-action" onclick="parsePaper()" id="parseBtn">è§£æ</button></div><div class="pane-content" id="originalContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·å…ˆæ·»åŠ è®ºæ–‡å¹¶è§£æ</p></div></div>
<div class="reading-pane"><div class="pane-header"><span>è¯‘æ–‡</span><button class="paper-action" onclick="translatePaper()" id="translateBtn">ç¿»è¯‘</button></div><div class="pane-content" id="translatedContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"è§£æ"åè·å–åŸæ–‡ï¼Œå†ç‚¹å‡»"ç¿»è¯‘"è·å–ä¸­æ–‡ç¿»è¯‘</p></div></div>
</div>
</div>
<div id="analysisMode" style="display:none">
<div class="analysis-header"><h1 class="analysis-title" id="analysisTitle"></h1><p class="analysis-meta" id="analysisMeta"></p></div>
<div id="analysisContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">è§£æè®ºæ–‡åå¯ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š</p></div>
</div>
</div>
</main>
<button class="toggle-btn toggle-right" id="toggleRight" onclick="toggleSidebar('right')">&#8250;</button>
<aside class="sidebar-right" id="sidebarRight">
<div class="chat-header"><h3 class="chat-title">Agent å¯¹è¯</h3></div>
<div class="quick-questions"><button class="quick-btn" onclick="askQuestion(this)">æ ¸å¿ƒåˆ›æ–°æ˜¯ä»€ä¹ˆï¼Ÿ</button><button class="quick-btn" onclick="askQuestion(this)">æ€»ç»“å®éªŒç»“æœ</button><button class="quick-btn" onclick="askQuestion(this)">è§£é‡Šç®—æ³•æµç¨‹</button></div>
<div class="chat-messages" id="chatMessages"><div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯è®ºæ–‡åˆ†æåŠ©æ‰‹ï¼Œè¯·å…ˆæ·»åŠ è®ºæ–‡ã€‚</div></div>
<div class="chat-input-area"><div class="chat-input-wrapper"><input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="if(event.key==='Enter')sendMessage()"><button class="send-btn" onclick="sendMessage()">å‘é€</button></div></div>
</aside>
</div>
<nav class="mobile-nav"><div class="mobile-nav-items"><div class="mobile-item active" onclick="mobileNav(1)"><span class="mobile-icon">â˜°</span><span>è®ºæ–‡åº“</span></div><div class="mobile-item" onclick="mobileNav(2)"><span class="mobile-icon">ğŸ“–</span><span>é˜…è¯»</span></div><div class="mobile-item" onclick="mobileNav(3)"><span class="mobile-icon">ğŸ“Š</span><span>åˆ†æ</span></div><div class="mobile-item" onclick="mobileNav(4)"><span class="mobile-icon">ğŸ’¬</span><span>é—®ç­”</span></div></div></nav>
<div class="modal-overlay" id="addPaperModal">
<div class="modal"><div class="modal-header"><span class="modal-title">æ·»åŠ è®ºæ–‡</span><span class="modal-close" onclick="hideAddPaperModal()">x</span></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">è¾“å…¥æ–¹å¼</label><select class="form-select" id="inputType" onchange="toggleInputMethod()"><option value="arxiv">arXiv ID (å•ä¸ª)</option><option value="arxiv-batch">arXiv ID (æ‰¹é‡)</option><option value="folder">ä»æ–‡ä»¶å¤¹æ‰¹é‡æ·»åŠ </option><option value="pdf">ä¸Šä¼  PDF</option></select></div>
<div class="form-group" id="singleArxivGroup"><label class="form-label">arXiv ID</label><input type="text" class="form-input" id="paperInput" placeholder="å¦‚ 2602.03219"></div>
<div class="form-group" id="batchArxivGroup" style="display:none"><label class="form-label">æ‰¹é‡è¾“å…¥ (æ¯è¡Œä¸€ä¸ª)</label><textarea class="form-textarea" id="batchInput" placeholder="2602.03219&#10;2503.14443"></textarea></div>
<div class="form-group" id="folderGroup" style="display:none"><label class="form-label">ä»æ–‡ä»¶å¤¹é€‰æ‹©</label><label class="form-file"><input type="file" id="folderFiles" webkitdirectory directory multiple onchange="handleFolderSelect(this)"><span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹</span></label><div class="file-list" id="fileList"></div></div>
<div class="form-group" id="pdfGroup" style="display:none"><label class="form-label">ä¸Šä¼  PDF</label><label class="form-file"><input type="file" id="pdfFiles" multiple accept=".pdf" onchange="handleFileSelect(this)"><span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></label><div class="file-list" id="pdfFileList"></div></div>
<div class="form-group"><label class="form-label">åˆ†ç±»</label><select class="form-select" id="paperCategory"><option value="benchmark">Benchmark</option><option value="long">é•¿æ–‡æœ¬</option><option value="agent">Agent</option><option value="multimodal">å¤šæ¨¡æ€</option></select></div>
<div class="form-group"><label class="form-label">è‡ªå®šä¹‰æ ‡ç­¾</label><div class="tag-input-wrapper"><input type="text" class="tag-input" id="customTagInput" placeholder="è¾“å…¥æ ‡ç­¾åå›è½¦æ·»åŠ " onkeypress="if(event.key==='Enter')addCustomTag()"><button class="add-tag-btn" onclick="addCustomTag()">æ·»åŠ </button></div><div class="custom-tags" id="customTags"></div></div>
</div>
<div class="modal-footer"><button class="nav-btn" onclick="hideAddPaperModal()">å–æ¶ˆ</button><button class="nav-btn primary" onclick="addPaper()">æ·»åŠ å¹¶è§£æ</button></div>
</div>
</div>
<script>
var papers = JSON.parse(localStorage.getItem('paperLibrary') || '[]');
var currentPaper = papers.length > 0 ? papers[0] : null;
var currentFilter = "all";
var selectedFiles = [];
var customTags = [];

function savePapers() { localStorage.setItem('paperLibrary', JSON.stringify(papers)); }

function renderPaperList() {
    var search = document.getElementById("paperSearch").value.toLowerCase();
    var filtered = papers.filter(function(p) {
        var matchFilter = currentFilter === "all" || p.tags.indexOf(currentFilter) !== -1;
        var matchSearch = p.title.toLowerCase().indexOf(search) !== -1 || (p.arxiv && p.arxiv.toLowerCase().indexOf(search) !== -1);
        return matchFilter && matchSearch;
    });
    if (filtered.length === 0) {
        document.getElementById("paperList").innerHTML = '<div class="paper-empty">è®ºæ–‡åº“ä¸ºç©º<br>ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ è®ºæ–‡"å¼€å§‹</div>';
    } else {
        document.getElementById("paperList").innerHTML = filtered.map(function(p) {
            var status = p.parsed ? '<span style="color:var(--green)">å·²è§£æ</span>' : '<span style="color:var(--orange)">æœªè§£æ</span>';
            return '<div class="paper-item ' + (currentPaper && p.id === currentPaper.id ? 'active' : '') + '" onclick="selectPaper(' + p.id + ')">' +
                '<div class="paper-delete" onclick="event.stopPropagation();deletePaper(' + p.id + ')">x</div>' +
                '<div class="paper-title">' + p.title + '</div>' +
                '<div class="paper-meta">' + (p.arxiv ? 'arXiv: ' + p.arxiv : 'PDF') + ' | ' + p.date + '</div>' +
                '<div class="paper-tags">' + p.tags.map(function(t) { return '<span class="paper-tag">' + t + '</span>'; }).join('') + '</div>' +
                '<div class="paper-status">' + status + '</div>' +
                '</div>';
        }).join('');
    }
}

function selectPaper(id) {
    currentPaper = papers.find(function(p){return p.id===id;});
    renderPaperList();
    updateContent();
    document.getElementById('translatedContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"ç¿»è¯‘"è·å–ä¸­æ–‡ç¿»è¯‘</p>';
    document.getElementById('analysisContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">è§£æè®ºæ–‡åå¯ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š</p>';
}

function updateContent() {
    if (!currentPaper) {
        document.getElementById("originalContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·å…ˆæ·»åŠ è®ºæ–‡å¹¶è§£æ</p>';
        document.getElementById("analysisTitle").innerHTML = '';
        return;
    }
    if (currentPaper.parsed && currentPaper.original) {
        document.getElementById("originalContent").innerHTML = currentPaper.original;
        document.getElementById("translatedContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"ç¿»è¯‘"è·å–ä¸­æ–‡ç¿»è¯‘</p>';
    } else {
        document.getElementById("originalContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·ç‚¹å‡»"è§£æ"æŒ‰é’®è§£æè®ºæ–‡</p>';
    }
    document.getElementById("analysisTitle").innerHTML = currentPaper.title;
    document.getElementById("analysisMeta").innerHTML = currentPaper.arxiv ? 'arXiv: ' + currentPaper.arxiv + ' | ' + currentPaper.date : currentPaper.date;
}

function parsePaper() {
    if (!currentPaper) return;
    var btn = document.getElementById('parseBtn');
    btn.innerHTML = '<span class="loading"></span> è§£æä¸­...';
    
    var apiUrl = (localStorage.getItem('apiUrl') || 'http://192.168.3.24:5001') + '/api/parse';
    var payload = {
        sourceType: 'arxiv',
        source: currentPaper.arxiv
    };
    
    fetch(apiUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(function(res){return res.json();})
    .then(function(data){
        if(data.success && data.data && data.data.markdown){
            var markdown = data.data.markdown;
            var htmlContent = convertMarkdownToHtml(markdown);
            
            currentPaper.title = data.data.title || currentPaper.title;
            currentPaper.abstract = data.data.abstract || '';
            currentPaper.original = htmlContent;
            currentPaper.parsed = true;
            
            savePapers();
            document.getElementById('originalContent').innerHTML = htmlContent;
            document.getElementById('analysisTitle').innerHTML = currentPaper.title;
        } else {
            alert('è§£æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            document.getElementById('originalContent').innerHTML = '<p style="color:var(--text-muted)">è§£æå¤±è´¥ï¼Œè¯·é‡è¯•</p>';
        }
        btn.textContent = 'è§£æ';
        renderPaperList();
    })
    .catch(function(err){
        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
        btn.textContent = 'è§£æ';
    });
}

function convertMarkdownToHtml(markdown) {
    var html = markdown
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    return html;
}

function translatePaper() {
    if (!currentPaper || !currentPaper.parsed) { alert('è¯·å…ˆè§£æè®ºæ–‡'); return; }
    var btn = document.getElementById('translateBtn');
    btn.innerHTML = '<span class="loading"></span> ç¿»è¯‘ä¸­...';
    setTimeout(function() {
        var translated = currentPaper.translated || '<h1>' + currentPaper.title + '</h1><h2>æ‘˜è¦</h2><p>è¿™æ˜¯è®ºæ–‡çš„ä¸­æ–‡ç¿»è¯‘ã€‚</p><h2>1. å¼•è¨€</h2><p>æœ¬æ–‡ç ”ç©¶äº†ç›¸å…³ä¸»é¢˜ã€‚</p>';
        currentPaper.translated = translated;
        savePapers();
        document.getElementById('translatedContent').innerHTML = translated;
        btn.textContent = 'ç¿»è¯‘';
    }, 1500);
}

function deletePaper(id) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ç¯‡è®ºæ–‡ï¼Ÿ")) {
        papers = papers.filter(function(p){return p.id!==id;});
        currentPaper = papers.length > 0 ? papers[0] : null;
        savePapers();
        renderPaperList();
        updateContent();
    }
}

function clearAllPapers() {
    if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®ºæ–‡ï¼Ÿ")) {
        papers = [];
        currentPaper = null;
        savePapers();
        renderPaperList();
        updateContent();
    }
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-tag').forEach(function(t){t.classList.remove('active');});
    event.target.classList.add('active');
    renderPaperList();
}

function switchMode(mode) {
    document.querySelectorAll('.mode-tab').forEach(function(t){t.classList.remove('active');});
    event.target.classList.add('active');
    document.getElementById('readingMode').style.display = mode === 'reading' ? 'block' : 'none';
    document.getElementById('analysisMode').style.display = mode === 'analysis' ? 'block' : 'none';
}

function toggleSidebar(side) {
    var left = document.getElementById('sidebarLeft');
    var right = document.getElementById('sidebarRight');
    var tl = document.getElementById('toggleLeft');
    var tr = document.getElementById('toggleRight');
    if(side === 'left'){
        left.classList.toggle('collapsed');
        tl.classList.toggle('collapsed');
        tl.innerHTML = left.classList.contains('collapsed') ? '&#8250;' : '&#8249;';
    } else {
        right.classList.toggle('collapsed');
        tr.classList.toggle('collapsed');
        tr.innerHTML = right.classList.contains('collapsed') ? '&#8249;' : '&#8250;';
    }
}

function showAddPaperModal(){
    document.getElementById('addPaperModal').classList.add('show');
    customTags = [];
    renderCustomTags();
}
function hideAddPaperModal(){
    document.getElementById('addPaperModal').classList.remove('show');
    selectedFiles = [];
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('pdfFileList').innerHTML = '';
    customTags = [];
}

function toggleInputMethod(){
    var t = document.getElementById('inputType').value;
    document.getElementById('singleArxivGroup').style.display = t === 'arxiv' ? 'block' : 'none';
    document.getElementById('batchArxivGroup').style.display = t === 'arxiv-batch' ? 'block' : 'none';
    document.getElementById('folderGroup').style.display = t === 'folder' ? 'block' : 'none';
    document.getElementById('pdfGroup').style.display = t === 'pdf' ? 'block' : 'none';
}

function handleFolderSelect(input){
    var files = input.files;
    selectedFiles = [];
    for(var i=0; i<files.length; i++) {
        if(files[i].name.toLowerCase().endsWith('.pdf')) {
            selectedFiles.push(files[i].name);
        }
    }
    renderFileList();
}

function handleFileSelect(input){
    var files = input.files;
    selectedFiles = [];
    for(var i=0; i<files.length; i++) {
        selectedFiles.push(files[i].name);
    }
    renderPdfFileList();
}

function renderFileList(){
    document.getElementById('fileList').innerHTML = selectedFiles.map(function(f,i){return '<div class="file-item"><span>' + f + '</span><span class="file-remove" onclick="selectedFiles.splice(' + i + ',1);renderFileList()">x</span></div>';}).join('');
}

function renderPdfFileList(){
    document.getElementById('pdfFileList').innerHTML = selectedFiles.map(function(f,i){return '<div class="file-item"><span>' + f + '</span><span class="file-remove" onclick="selectedFiles.splice(' + i + ',1);renderPdfFileList()">x</span></div>';}).join('');
}

function addCustomTag(){
    var input = document.getElementById('customTagInput');
    var tag = input.value.trim();
    if(tag && customTags.indexOf(tag) === -1) {
        customTags.push(tag);
        input.value = '';
        renderCustomTags();
    }
}

function removeCustomTag(index){
    customTags.splice(index, 1);
    renderCustomTags();
}

function renderCustomTags(){
    document.getElementById('customTags').innerHTML = customTags.map(function(t,i){return '<span class="custom-tag">' + t + '<span onclick="removeCustomTag(' + i + ')">x</span></span>';}).join('');
}

function addPaper(){
    var type = document.getElementById('inputType').value;
    var category = document.getElementById('paperCategory').value;
    var newPapers = [];
    var newId = papers.length > 0 ? Math.max.apply(null, papers.map(function(p){return p.id;})) + 1 : 1;
    var allTags = [category].concat(customTags);
    
    if(type === 'arxiv'){
        var id = document.getElementById('paperInput').value.trim();
        if(id) newPapers.push({id:newId,title:"è®ºæ–‡ " + id,arxiv:id,date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",parsed:false});
    } else if(type === 'arxiv-batch'){
        var ids = document.getElementById('batchInput').value.split('\n').filter(function(x){return x.trim();});
        ids.forEach(function(id,i){newPapers.push({id:newId+i,title:"è®ºæ–‡ " + id.trim(),arxiv:id.trim(),date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",parsed:false});});
    } else if(type === 'folder' || type === 'pdf'){
        selectedFiles.forEach(function(f,i){newPapers.push({id:newId+i,title:f.replace('.pdf',''),arxiv:"PDF",date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",parsed:false});});
    }
    
    papers.unshift.apply(papers, newPapers);
    currentPaper = papers[0];
    savePapers();
    renderPaperList();
    updateContent();
    hideAddPaperModal();
    
    // è‡ªåŠ¨è§£æç¬¬ä¸€ç¯‡
    if(newPapers.length > 0) {
        selectPaper(newPapers[0].id);
        parsePaper();
    }
}

function askQuestion(btn){document.getElementById('chatInput').value = btn.textContent;sendMessage();}
function sendMessage(){
    var input = document.getElementById('chatInput');
    var msg = input.value.trim();
    if(!msg) return;
    var m = document.getElementById('chatMessages');
    m.innerHTML += '<div class="chat-bubble user">' + msg + '</div><div class="chat-bubble">æ­£åœ¨åˆ†æ...</div>';
    m.scrollTop = m.scrollHeight;
    input.value = '';
}

renderPaperList();
updateContent();

function showApiSettings(){
    var url = prompt("è¯·è¾“å…¥ API æœåŠ¡å™¨åœ°å€:", localStorage.getItem("apiUrl") || 'http://192.168.3.24:5001');
    if(url){
        localStorage.setItem("apiUrl", url);
        alert("API å·²æ›´æ–°ä¸º: " + url);
    }
}

function toggleMobileSidebar(){
    var sidebar = document.getElementById('sidebarLeft');
    var overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

function mobileNav(tab){
    document.querySelectorAll('.mobile-item').forEach(function(el){el.classList.remove('active');});
    event.target.closest('.mobile-item').classList.add('active');
    if(tab === 1){
        var sidebar = document.getElementById('sidebarLeft');
        var overlay = document.getElementById('mobileOverlay');
        sidebar.classList.add('show');
        overlay.classList.add('show');
    } else if(tab === 2){
        switchMode('reading');
        document.querySelectorAll('.mode-tab')[0].classList.add('active');
        document.querySelectorAll('.mode-tab')[1].classList.remove('active');
    } else if(tab === 3){
        switchMode('analysis');
        document.querySelectorAll('.mode-tab')[1].classList.add('active');
        document.querySelectorAll('.mode-tab')[0].classList.remove('active');
    }
}
</script>
</body>
</html>
