<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paper Analyzer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg-primary:#121212;--bg-secondary:#1A1B1E;--bg-tertiary:#25262B;--border-color:#3A3C40;--accent:#9B7ED9;--text-primary:#FFFFFF;--text-secondary:#A0A0A0;--text-muted:#6B6B6B;--blue:#4A90D9;--orange:#E8A87C;--green:#7ED98E;--red:#C25D5D}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-secondary)}
::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
.top-nav{position:fixed;top:0;left:0;right:0;height:52px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
.nav-left{display:flex;align-items:center;gap:16px}
.nav-logo{font-size:16px;font-weight:700;color:var(--accent)}
.nav-tabs{display:flex;gap:4px}
.nav-tab{padding:8px 16px;font-size:13px;color:var(--text-secondary);cursor:pointer;border-radius:6px;border:none;background:transparent}
.nav-tab.active{background:var(--accent);color:white}
.nav-right{display:flex;gap:8px}
.nav-btn{padding:7px 14px;font-size:12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);cursor:pointer}
.nav-btn.primary{background:var(--accent);border-color:var(--accent);color:white}
.container{display:flex;height:calc(100vh - 52px);margin-top:52px;position:relative}
.sidebar-left{width:300px;background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;transition:all .3s}
.sidebar-left.collapsed{width:0;overflow:hidden}
.sidebar-right{width:300px;background:var(--bg-secondary);border-left:1px solid var(--border-color);display:flex;flex-direction:column;transition:all .3s}
.sidebar-right.collapsed{width:0;overflow:hidden}
.toggle-btn{position:fixed;top:50%;transform:translateY(-50%);width:20px;height:40px;background:var(--bg-tertiary);border:1px solid var(--border-color);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-muted);z-index:10;transition:right 0.3s ease,left 0.3s ease}
.toggle-left{left:300px;border-radius:0 6px 6px 0;transition:left 0.3s ease}
.toggle-left.collapsed{left:0}
.toggle-right{right:300px;border-radius:6px 0 0 6px;transition:right 0.3s ease}
.toggle-right.collapsed{right:0}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border-color)}
.search-input{width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:16px;margin-bottom:12px}
.filter-tags{display:flex;flex-wrap:wrap;gap:6px}
.filter-tag{padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid transparent}
.filter-tag.active{background:var(--blue);color:white}
.filter-tag:not(.active){background:var(--bg-tertiary);color:var(--text-secondary)}
.paper-list{flex:1;overflow-y:auto;padding:8px}
.paper-empty{padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px}
.paper-item{position:relative;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid transparent}
.paper-item:hover{background:var(--bg-tertiary)}
.paper-item.active{background:var(--bg-tertiary);border-color:var(--blue)}
.paper-delete{position:absolute;top:8px;right:8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:white;font-size:12px;display:none;align-items:center;justify-content:center;cursor:pointer;line-height:1}
.paper-item:hover .paper-delete{display:flex}
.paper-title{font-size:13px;font-weight:500;margin-bottom:4px;padding-right:20px}
.paper-meta{font-size:11px;color:var(--blue)}
.paper-tags{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px}
.ptag{font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:3px;color:var(--text-secondary)}
.paper-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.paper-tag{padding:2px 6px;border-radius:3px;font-size:10px;background:var(--bg-primary);color:var(--text-muted)}
.paper-status{font-size:10px;margin-top:6px;color:var(--text-muted)}
.main-content{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.mode-tabs{display:flex;gap:4px;padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color)}
.mode-tab{padding:8px 20px;font-size:13px;color:var(--text-secondary);cursor:pointer;border-radius:6px;border:none;background:transparent}
.mode-tab.active{background:var(--accent);color:white}
.main-scroll{flex:1;overflow-y:auto;padding:20px}
.reading-container{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.reading-pane{background:var(--bg-secondary);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.pane-header{padding:12px 16px;background:var(--bg-tertiary);font-size:13px;font-weight:600;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.pane-content{flex:1;overflow-y:auto;padding:20px;font-size:14px;line-height:1.8}
.pane-content h1{font-size:20px;margin-bottom:16px}
.pane-content h2{font-size:16px;margin:20px 0 10px;color:var(--accent)}
.pane-content p{margin-bottom:12px;color:var(--text-secondary)}
.loading{display:inline-block;width:14px;height:14px;border:2px solid var(--border-color);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.analysis-header{margin-bottom:24px}
.analysis-title{font-size:22px;font-weight:700;margin-bottom:8px}
.analysis-meta{font-size:12px;color:var(--text-muted)}
.analysis-section{background:var(--bg-secondary);border-radius:12px;padding:20px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.section-dot{width:8px;height:8px;border-radius:50%}
.section-list{list-style:none}
.section-list li{font-size:13px;color:var(--text-secondary);margin-bottom:8px;padding-left:16px;position:relative}
.section-list li::before{content:"â€¢";position:absolute;left:0;color:var(--accent)}
.dimension-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
.dimension-card{border-radius:12px;padding:16px;min-height:180px}
.dimension-card.blue{background:linear-gradient(135deg,#1a3a5c,#0d1f33);border:1px solid #2a5a8c}
.dimension-card.orange{background:linear-gradient(135deg,#4a3520,#2d1f14);border:1px solid #8a5a30}
.dimension-card.green{background:linear-gradient(135deg,#1a4a30,#0d2a1c);border:1px solid #2a7a50}
.dimension-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.dimension-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center}
.dimension-card.blue .dimension-icon{background:var(--blue)}
.dimension-card.orange .dimension-icon{background:var(--orange)}
.dimension-card.green .dimension-icon{background:var(--green)}
.dimension-title{font-size:13px;font-weight:600}
.dimension-card.blue .dimension-title{color:var(--blue)}
.dimension-card.orange .dimension-title{color:var(--orange)}
.dimension-card.green .dimension-title{color:var(--green)}
.dimension-content{font-size:12px;color:var(--text-secondary);margin-bottom:12px}
.dimension-score{display:flex;align-items:center;gap:8px;padding-top:10px;border-top:1px solid rgba(255,255,255,.1)}
.score-badge{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}
.dimension-card.blue .score-badge{background:var(--blue);color:white}
.dimension-card.orange .score-badge{background:var(--orange);color:#1a1a1a}
.dimension-card.green .score-badge{background:var(--green);color:#1a1a1a}
.score-label{font-size:11px;color:var(--text-muted)}
.chat-header{padding:16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
.chat-tabs{display:flex;gap:4px;overflow-x:auto;padding:4px 16px 4px 0;background:var(--bg-secondary)}
.chat-tabs::-webkit-scrollbar{height:6px}
.chat-tabs::-webkit-scrollbar-track{background:var(--bg-secondary)}
.chat-tabs::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
.chat-tab{padding:4px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px 4px 0 0;font-size:12px;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all 0.2s ease}
.chat-tab:hover{background:var(--bg-secondary)}
.chat-tab.active{background:var(--accent);color:white;border-color:var(--accent)}
.chat-tab-close{margin-left:6px;font-size:11px;opacity:0.7;padding:2px 4px;border-radius:3px}
.chat-tab-close:hover{opacity:1;background:rgba(255,255,255,0.2)}
.chat-tab-add{padding:4px 10px;background:transparent;border:1px dashed var(--border-color);border-radius:4px 4px 0 0;font-size:13px;color:var(--text-muted);cursor:pointer}
.chat-tab-add:hover{background:var(--accent);color:white;border-color:var(--accent)}
.chat-title{font-size:14px;font-weight:600}
.quick-questions{padding:0 16px 12px 16px;display:flex;flex-direction:column;gap:8px}
.quick-btn{padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);font-size:13px;text-align:left;cursor:pointer}
.quick-btn:hover{background:var(--border-color)}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.chat-bubble{padding:12px 14px;background:var(--bg-tertiary);border-radius:10px;font-size:13px;color:var(--text-secondary)}
.chat-bubble.user{background:var(--accent);color:white;align-self:flex-end}
.chat-input-area{padding:16px;border-top:1px solid var(--border-color)}
.chat-input-wrapper{display:flex;gap:8px}
.chat-input{flex:1;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:16px}
.send-btn{padding:10px 16px;background:var(--accent);border:none;border-radius:8px;color:white;cursor:pointer}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:200}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-secondary);border-radius:12px;width:560px;max-width:90vw;border:1px solid var(--border-color);max-height:80vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between}
.modal-title{font-size:15px;font-weight:600}
.modal-close{cursor:pointer;color:var(--text-muted)}
.modal-body{padding:20px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:16px}
.form-textarea{min-height:100px;resize:vertical}
.form-file{width:100%;padding:20px;background:var(--bg-tertiary);border:2px dashed var(--border-color);border-radius:6px;text-align:center;cursor:pointer}
.form-file:hover{border-color:var(--accent)}
.form-file input{display:none}
.file-list{margin-top:12px}
.file-item{display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;font-size:16px}
.file-remove{cursor:pointer;color:var(--red)}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:8px}
.tag-input-wrapper{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.tag-input{flex:1;min-width:80px;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-primary);font-size:16px}
.tag-input:focus{border-color:var(--accent);outline:none}
.add-tag-btn{padding:6px 10px;background:var(--accent);border:none;border-radius:4px;color:white;font-size:11px;cursor:pointer}
.custom-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.custom-tag{display:flex;align-items:center;gap:4px;padding:3px 8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;font-size:11px;color:var(--text-secondary)}
.custom-tag span{cursor:pointer;color:var(--red)}
.mobile-nav{display:none}
@media(max-width:1200px){.dimension-cards{grid-template-columns:1fr}}
@media(max-width:1024px){.sidebar-right{width:300px;position:fixed;right:0;top:52px;bottom:60px;z-index:99}}
@media(max-width:768px){
.container{height:auto;min-height:calc(100vh - 52px);flex-direction:column}
.sidebar-left{position:fixed;top:52px;left:0;bottom:60px;width:280px;z-index:50;transform:translateX(-100%);transition:transform .3s}
.sidebar-left.show{transform:translateX(0)}
.sidebar-left.collapsed{transform:translateX(-100%);width:280px}
.toggle-left{display:none}
.toggle-right{display:none}
.reading-container{grid-template-columns:1fr;gap:12px;padding:12px}
.reading-pane{min-height:300px}
.pane-content{padding:12px;font-size:13px}
.pane-header{padding:10px 12px;font-size:16px}
.nav-tabs{display:none}
.nav-right{padding-right:0}
.nav-btn{padding:6px 10px;font-size:11px}
.mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);padding:6px 0;z-index:100}
.mobile-nav-items{display:flex;justify-content:space-around;width:100%}
.mobile-item{display:flex;flex-direction:column;align-items:center;font-size:10px;color:var(--text-muted);cursor:pointer}
.mobile-item.active{color:var(--accent)}
.mobile-icon{font-size:22px;margin-bottom:2px}
.main-content{padding-bottom:70px}
.mode-tabs{padding:8px 12px;overflow-x:auto}
.mode-tab{padding:6px 14px;font-size:12px;white-space:nowrap}
.mobile-menu-btn{display:none;width:32px;height:32px;align-items:center;justify-content:center;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;color:var(--text-secondary)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;display:none}
.overlay.show{display:block}
}

.paper-action2{background:linear-gradient(135deg,#9B7ED9,#7B5DB8);color:#fff;border:none;padding:10px 24px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(155,126,217,0.3)}
.paper-action2:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(155,126,217,0.5)}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js">

function downloadPaper() {
    if (!currentPaper) { alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡è®ºæ–‡'); return; }
    var data = {
        title: currentPaper.title,
        arxiv: currentPaper.arxiv,
        date: currentPaper.date,
        tags: currentPaper.tags,
        abstract: currentPaper.abstract,
        original: currentPaper.original,
        translated: currentPaper.translated,
        analysis: currentPaper.analysis,
        peerReview: currentPaper.peerReview,
        exportedAt: new Date().toISOString()
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (currentPaper.title || currentPaper.arxiv || 'paper') + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
}

function hideImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function importPaper() {
    var file = document.getElementById('importFile').files[0];
    if (!file) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            var newId = papers.length > 0 ? Math.max.apply(null, papers.map(function(p){return p.id;})) + 1 : 1;
            var newPaper = {
                id: newId,
                title: data.title || 'æœªçŸ¥è®ºæ–‡',
                arxiv: data.arxiv || '',
                date: data.date || new Date().toISOString().split('T')[0],
                tags: data.tags || [],
                abstract: data.abstract || '',
                original: data.original || '',
                translated: data.translated || '',
                analysis: data.analysis || '',
                peerReview: data.peerReview || '',
                parsed: !!data.original
            };
            papers.unshift(newPaper);
            currentPaper = papers[0];
            renderPaperList();
            updateContent();
            savePapers(); // ä¿å­˜åˆ° SQLite
            hideImportModal();
            alert('å¯¼å…¥æˆåŠŸ: ' + data.title);
        } catch(err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); }
    };
    reader.readAsText(file);
}
</script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js">

function downloadPaper() {
    if (!currentPaper) { alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡è®ºæ–‡'); return; }
    var data = {
        title: currentPaper.title,
        arxiv: currentPaper.arxiv,
        date: currentPaper.date,
        tags: currentPaper.tags,
        abstract: currentPaper.abstract,
        original: currentPaper.original,
        translated: currentPaper.translated,
        analysis: currentPaper.analysis,
        peerReview: currentPaper.peerReview,
        exportedAt: new Date().toISOString()
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (currentPaper.title || currentPaper.arxiv || 'paper') + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
}

function hideImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function importPaper() {
    var file = document.getElementById('importFile').files[0];
    if (!file) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            var papersList = papers.slice();
            var newId = papersList.length > 0 ? Math.max.apply(null, papersList.map(function(p){return p.id;})) + 1 : 1;
            papersList.unshift({
                id: newId,
                title: data.title || 'æœªçŸ¥è®ºæ–‡',
                arxiv: data.arxiv || '',
                date: data.date || new Date().toISOString().split('T')[0],
                tags: data.tags || [],
                abstract: data.abstract || '',
                original: data.original || '',
                translated: data.translated || '',
                analysis: data.analysis || '',
                peerReview: data.peerReview || '',
                parsed: !!data.original
            });
            // localStorage.setItem('paperLibrary', JSON.stringify(papersList));
            papers = papersList;
            currentPaper = papers[0];
            renderPaperList();
            updateContent();
            hideImportModal();
            alert('å¯¼å…¥æˆåŠŸ: ' + data.title);
        } catch(err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); }
    };
    reader.readAsText(file);
}
</script>
</head>
<body>
<nav class="top-nav">
<div class="nav-left"><span class="nav-logo">Paper Analyzer</span>
<div class="nav-tabs"><button class="nav-tab active">è®ºæ–‡åº“</button><button class="nav-tab">é˜…è¯»æ¨¡å¼</button><button class="nav-tab">åˆ†ææŠ¥å‘Š</button><button class="nav-tab">åŒè¡Œè¯„å®¡</button><button class="nav-tab">è¯­ä¹‰æ£€ç´¢</button></div>
</div>
<div class="nav-right"><button class="nav-btn" onclick="showAddPaperModal()">+ æ·»åŠ è®ºæ–‡</button><button class="nav-btn" onclick="clearAllPapers()">æ¸…ç©º</button><button class="nav-btn" onclick="showApiSettings()">API</button><button class="nav-btn" onclick="downloadPaper()">å¯¼å‡º</button>
<button class="nav-btn" onclick="showImportModal()">å¯¼å…¥</button></div>
</nav>
<div class="overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div><div class="container">
<aside class="sidebar-left" id="sidebarLeft">
<div class="sidebar-header"><input type="text" class="search-input" placeholder="æœç´¢è®ºæ–‡..." id="paperSearch" oninput="renderPaperList()">
<div class="filter-tags" id="filterTags"></div>
</div>
<div class="paper-list" id="paperList"></div>
</aside>
<button class="toggle-btn toggle-left" id="toggleLeft" onclick="toggleSidebar('left')">&#8249;</button>
<main class="main-content">
<div class="mode-tabs"><button class="mode-tab active" onclick="switchMode('reading')">é˜…è¯»æ¨¡å¼</button><button class="mode-tab" onclick="switchMode('analysis')">åˆ†ææŠ¥å‘Š</button><button class="mode-tab" onclick="switchMode('peerReview')">åŒè¡Œè¯„å®¡</button><button class="mode-tab" onclick="switchMode('semanticSearch')">è¯­ä¹‰æ£€ç´¢</button><button class="mode-tab" onclick="switchMode('hotPapers')">çƒ­ç‚¹æ¨è</button></div>
<div class="main-scroll">
<div id="readingMode">
<div class="reading-container">
<div class="reading-pane"><div class="pane-header"><span>åŸæ–‡</span><button class="paper-action2" onclick="parsePaper()" id="parseBtn">è§£æ</button></div><div class="pane-content" id="originalContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·å…ˆæ·»åŠ è®ºæ–‡å¹¶è§£æ</p></div></div>
<div class="reading-pane"><div class="pane-header"><span>è¯‘æ–‡</span><button class="paper-action2" onclick="translatePaper()" id="translateBtn">ç¿»è¯‘</button></div><div class="pane-content" id="translatedContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"è§£æ"åè·å–åŸæ–‡ï¼Œå†ç‚¹å‡»"ç¿»è¯‘"è·å–ä¸­æ–‡ç¿»è¯‘</p></div></div>
</div>
</div>
<div id="analysisMode" style="display:none">
<div class="analysis-header">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <h1 class="analysis-title" id="analysisTitle" style="margin:0"></h1>
        <button class="paper-action2" id="analyzeBtn" onclick="generateAnalysis()">ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
    </div>
    <p class="analysis-meta" id="analysisMeta"></p>
</div>
<div id="analysisContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">è§£æè®ºæ–‡åå¯ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š</p></div>
</div>

<div id="peerReviewMode" style="display:none">
<div class="analysis-header">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <h1 class="analysis-title" id="peerReviewTitle" style="margin:0"></h1>
        <button class="paper-action2" id="peerReviewBtn" onclick="generatePeerReview()">ç”ŸæˆåŒè¡Œè¯„å®¡</button>
    </div>
    <p class="analysis-meta" id="peerReviewMeta"></p>
</div>
<div id="peerReviewContent"><p style="color:var(--text-muted);text-align:center;margin-top:40px">è§£æè®ºæ–‡åå¯ç”ŸæˆåŒè¡Œè¯„å®¡</p></div>
</div>

<div id="semanticSearchMode" style="display:none">
<div style="padding:20px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ç›¸å…³è®ºæ–‡..." style="flex:1;padding:10px 16px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);font-size:16px">
        <select id="sortBy" style="padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);font-size:16px">
            <option value="citationCount">å¼•ç”¨é‡</option>
            <option value="year">å‘è¡¨å¹´ä»½</option>
            <option value="relevance">ç›¸ä¼¼åº¦</option>
        </select>
        <button class="paper-action2" onclick="doSemanticSearch()">æ£€ç´¢</button>
    </div>
    <p id="searchStats" style="font-size:12px;color:var(--text-muted);margin-bottom:12px"></p>
</div>
<div id="searchResults" style="padding:0 20px 20px;display:flex;flex-direction:column;gap:12px">
    <p style="color:var(--text-muted);text-align:center;margin-top:40px">è¾“å…¥å…³é”®è¯æœç´¢ç›¸å…³è®ºæ–‡</p>
</div>
</div>

<div id="hotPapersMode" style="display:none">
<div style="padding:20px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <button class="paper-action2" onclick="fetchHotPapers()">åˆ·æ–°çƒ­ç‚¹</button>
        <select id="hotDateSelect" onchange="loadHotPapers()" style="padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);font-size:16px">
            <option value="">é€‰æ‹©æ—¥æœŸ</option>
        </select>
    </div>
    <div id="hotTopicsList" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px"></div>
    <p id="hotPapersStats" style="font-size:12px;color:var(--text-muted);margin-bottom:12px"></p>
</div>
<div id="hotPapersList" style="padding:0 20px 20px;display:flex;flex-direction:column;gap:12px">
    <p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"åˆ·æ–°çƒ­ç‚¹"è·å–æœ€æ–°è®ºæ–‡</p>
</div>
</div>

</main>
<button class="toggle-btn toggle-right" id="toggleRight" onclick="toggleSidebar('right')">&#8250;</button>
<aside class="sidebar-right" id="sidebarRight">
<div class="chat-header" style="flex-direction:column;align-items:stretch;border-bottom:none">
    <div style="display:flex;align-items:center;padding:4px 0 4px 0">
        <span style="font-size:13px;font-weight:600">Agent å¯¹è¯</span>
        <span class="chat-tab-add" onclick="createNewChat()" style="margin-left:auto">+ æ–°å»ºå¯¹è¯</span>
    </div>
    <div class="chat-tabs" id="chatTabs" style="padding:4px 16px 4px 0">
        <div class="chat-tab active" id="chatTabDefault" onclick="switchChatTab('default')">é»˜è®¤å¯¹è¯</div>
    </div>
</div>
<div class="quick-questions"><button class="quick-btn" onclick="askQuestion(this)">æ ¸å¿ƒåˆ›æ–°æ˜¯ä»€ä¹ˆï¼Ÿ</button><button class="quick-btn" onclick="askQuestion(this)">æ€»ç»“å®éªŒç»“æœ</button><button class="quick-btn" onclick="askQuestion(this)">è§£é‡Šç®—æ³•æµç¨‹</button></div>
<div class="chat-messages" id="chatMessages"><div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯è®ºæ–‡åˆ†æåŠ©æ‰‹ï¼Œè¯·å…ˆæ·»åŠ è®ºæ–‡ã€‚</div></div>
<div class="chat-input-area"><div class="chat-input-wrapper"><input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="if(event.key==='Enter')sendMessage()"><button class="send-btn" onclick="sendMessage()">å‘é€</button></div></div>
</aside>
</div>
<nav class="mobile-nav"><div class="mobile-nav-items"><div class="mobile-item active" onclick="mobileNav(1)"><span class="mobile-icon">ğŸ“š</span><span>è®ºæ–‡</span></div><div class="mobile-item" onclick="mobileNav(2)"><span class="mobile-icon">ğŸ“–</span><span>é˜…è¯»</span></div><div class="mobile-item" onclick="mobileNav(3)"><span class="mobile-icon">ğŸ“Š</span><span>åˆ†æ</span></div><div class="mobile-item" onclick="mobileNav(4)"><span class="mobile-icon">ğŸ“</span><span>è¯„å®¡</span></div><div class="mobile-item" onclick="mobileNav(5)"><span class="mobile-icon">ğŸ”</span><span>æ£€ç´¢</span></div><div class="mobile-item" onclick="mobileNav(6)"><span class="mobile-icon">ğŸ”¥</span><span>çƒ­ç‚¹</span></div><div class="mobile-item" onclick="mobileNav(7)"><span class="mobile-icon">ğŸ’¬</span><span>å¯¹è¯</span></div></div></nav>
<div class="modal-overlay" id="addPaperModal">
<div class="modal"><div class="modal-header"><span class="modal-title">æ·»åŠ è®ºæ–‡</span><span class="modal-close" onclick="hideAddPaperModal()">x</span></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">è¾“å…¥æ–¹å¼</label><select class="form-select" id="inputType" onchange="toggleInputMethod()"><option value="arxiv">arXiv ID (å•ä¸ª)</option><option value="arxiv-batch">arXiv ID (æ‰¹é‡)</option><option value="folder">ä»æ–‡ä»¶å¤¹æ‰¹é‡æ·»åŠ </option><option value="pdf">ä¸Šä¼  PDF</option>
<option value="pdf-url">PDF URL</option></select></div>
<div class="form-group" id="singleArxivGroup"><label class="form-label">arXiv ID</label><input type="text" class="form-input" id="paperInput" placeholder="å¦‚ 2602.03219"></div>
<div class="form-group" id="batchArxivGroup" style="display:none"><label class="form-label">æ‰¹é‡è¾“å…¥ (æ¯è¡Œä¸€ä¸ª)</label><textarea class="form-textarea" id="batchInput" placeholder="2602.03219&#10;2503.14443"></textarea></div>
<div class="form-group" id="folderGroup" style="display:none"><label class="form-label">ä»æ–‡ä»¶å¤¹é€‰æ‹©</label><label class="form-file"><input type="file" id="folderFiles" webkitdirectory directory multiple onchange="handleFolderSelect(this)"><span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹</span></label><div class="file-list" id="fileList"></div></div>
<div class="form-group" id="pdfGroup" style="display:none"><label class="form-label">ä¸Šä¼  PDF</label><label class="form-file"><input type="file" id="pdfFiles" multiple accept=".pdf" onchange="handleFileSelect(this)"><span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></label><div class="file-list" id="pdfFileList"></div></div>
<div class="form-group" id="pdfUrlGroup" style="display:none"><label class="form-label">PDF URL</label><input type="text" class="form-input" id="pdfUrlInput" placeholder="å¦‚ https://arxiv.org/pdf/2312.09993.pdf"></div>

<div class="form-group"><label class="form-label">è‡ªå®šä¹‰æ ‡ç­¾</label><div class="tag-input-wrapper"><input type="text" class="tag-input" id="customTagInput" placeholder="è¾“å…¥æ ‡ç­¾åå›è½¦æ·»åŠ " onkeypress="if(event.key==='Enter')addCustomTag()"><button class="add-tag-btn" onclick="addCustomTag()">æ·»åŠ </button></div><div class="custom-tags" id="customTags"></div></div>
</div>
<div class="modal-footer"><button class="nav-btn" onclick="hideAddPaperModal()">å–æ¶ˆ</button><button class="nav-btn primary" onclick="addPaper()">æ·»åŠ å¹¶è§£æ</button></div>
</div>
</div>
<script>
var papers = [];
var currentPaper = null;
var currentFilter = "all";
var selectedFiles = [];
var pdfFiles = [];
var customTags = [];

// å¯¹è¯ç›¸å…³å˜é‡
var chatSessions = [];
var currentChatSession = null;  // å½“å‰ä¼šè¯ uuid

// åˆå§‹åŒ–å¯¹è¯
function initChat() {
    loadChatSessions();
}

function loadChatSessions() {
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/chat/sessions')
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                chatSessions = d.data;
                // å¦‚æœæœ‰ä¼šè¯ä¸”å½“å‰æ²¡æœ‰é€‰ä¸­ï¼ŒåŠ è½½æœ€æ–°çš„ä¼šè¯
                if(chatSessions.length > 0 && (!currentChatSession || currentChatSession === 'default')) {
                    currentChatSession = chatSessions[chatSessions.length-1].uuid;
                }
                renderChatTabs();
                loadChatMessages();
            }
        })
        .catch(function(e){console.error('åŠ è½½ä¼šè¯å¤±è´¥:', e);});
}

function renderChatTabs() {
    var tabs = document.getElementById('chatTabs');
    var html = '';
    
    // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œæ˜¾ç¤ºæç¤º
    if (chatSessions.length === 0) {
        html = '<div class="chat-tab active">æš‚æ— å¯¹è¯</div>';
    } else {
        // æœ‰ä¼šè¯æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯æ ‡ç­¾
        chatSessions.forEach(function(s) {
            var title = s.title || 'æ–°å¯¹è¯';
            html += '<div class="chat-tab' + (currentChatSession === s.uuid ? ' active' : '') + '" onclick="switchChatTab(\'' + s.uuid + '\')">' + title + '<span class="chat-tab-close" onclick="event.stopPropagation();deleteChat(\'' + s.uuid + '\')">Ã—</span></div>';
        });
    }
    
    tabs.innerHTML = html;
}

function createNewChat() {
    var apiUrl = 'http://192.168.3.24:5001';
    var paperId = currentPaper ? currentPaper.id : null;
    fetch(apiUrl + '/api/chat/sessions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: 'æ–°å¯¹è¯', paper_id: paperId})
    })
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success && d.data) {
            chatSessions.push(d.data);
            renderChatTabs();
            switchChatTab(d.data.uuid);
        }
    })
    .catch(function(e){console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', e);});
}

function switchChatTab(uuid) {
    currentChatSession = uuid;
    renderChatTabs();
    loadChatMessages();
}

function deleteChat(uuid) {
    if(!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;
    
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/chat/sessions/' + uuid, {method: 'DELETE'})
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success) {
                chatSessions = chatSessions.filter(function(s){return s.uuid !== uuid;});
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°æœ€æ–°ä¼šè¯
                if(currentChatSession === uuid) {
                    currentChatSession = chatSessions.length > 0 ? chatSessions[chatSessions.length-1].uuid : null;
                }
                renderChatTabs();
                loadChatMessages();
            }
        })
        .catch(function(e){console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', e);});
}

function loadChatMessages() {
    var m = document.getElementById('chatMessages');
    
    // å¦‚æœæ²¡æœ‰ä¼šè¯
    if(chatSessions.length === 0) {
        m.innerHTML = '<div class="chat-bubble">æš‚æ— å¯¹è¯ï¼Œç‚¹å‡»"+"æ–°å»ºå¯¹è¯</div>';
        return;
    }
    
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/chat/sessions/' + currentChatSession + '/messages')
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                if(d.data.length === 0) {
                    m.innerHTML = '<div class="chat-bubble">æ–°å¯¹è¯å¼€å§‹ï¼Œè¯·æé—®ã€‚</div>';
                } else {
                    m.innerHTML = d.data.map(function(msg){
                        return '<div class="chat-bubble' + (msg.role === 'user' ? ' user' : '') + '">' + (msg.role === 'assistant' ? parseMarkdown(msg.content) : msg.content) + '</div>';
                    }).join('');
                }
                m.scrollTop = m.scrollHeight;
            }
        })
        .catch(function(e){console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', e);});
}

// åˆå§‹åŒ–ï¼šä» SQLite åŠ è½½è®ºæ–‡
    
function initPapers() {
    var apiUrl = 'http://192.168.3.24:5001';
    if (!apiUrl) apiUrl = 'http://192.168.3.24:5001';
    
    var papersUrl = apiUrl + '/api/papers';
    fetch(papersUrl)
        .then(function(r) { 
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.text(); 
        })
        .then(function(text) {
            try {
                var d = JSON.parse(text);
                if (d && d.success && d.data) {
                    papers = d.data;
                    // è§£æ tags å­—ç¬¦ä¸²ä¸ºæ•°ç»„
                    papers.forEach(function(p) {
                        if (typeof p.tags === 'string') {
                            try { p.tags = JSON.parse(p.tags); } catch(e) { p.tags = []; }
                        }
                        if (!p.tags) p.tags = [];
                    });
                    currentPaper = papers.length > 0 ? papers[0] : null;
                    renderPaperList();
                    updateContent();
                    return;
                }
            } catch(e) {
                console.error('è§£æJSONå¤±è´¥:', e);
            }
            // å¦‚æœè§£æå¤±è´¥æˆ–æ•°æ®æ— æ•ˆï¼Œfallback åˆ° localStorage
            throw new Error('invalid response');
        })
        .catch(function(e) { 
            console.error('ä»åç«¯åŠ è½½å¤±è´¥:', e); 
            // ç¦ç”¨ localStorage åå¤‡ï¼Œç›´æ¥ä½¿ç”¨ç©ºæ•°ç»„
            papers = [];
            currentPaper = null;
            renderPaperList();
            updateContent();
        });
}

function savePapers() { 
    var apiUrl = 'http://192.168.3.24:5001';
    if (!apiUrl) apiUrl = 'http://192.168.3.24:5001';
    papers.forEach(function(p) {
        // ç¡®ä¿ tags æ˜¯æ•°ç»„
        var paperToSave = Object.assign({}, p);
        if (Array.isArray(paperToSave.tags)) {
            paperToSave.tags = paperToSave.tags;
        }
        fetch(apiUrl + '/api/papers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(paperToSave)
        })
        .then(function(r) { 
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json(); 
        })
        .catch(function(e) { console.error('ä¿å­˜åˆ°åç«¯å¤±è´¥:', e); });
    });
}

function renderFilterTags() {
    var allTags = new Set();
    papers.forEach(function(p) {
        if (p.tags) {
            p.tags.forEach(function(t) { allTags.add(t); });
        }
    });
    
    var tags = Array.from(allTags).sort();
    var html = '<span class="filter-tag ' + (currentFilter === "all" ? "active" : "") + '" onclick="setFilter(\'all\')">å…¨éƒ¨</span>';
    tags.forEach(function(t) {
        html += '<span class="filter-tag ' + (currentFilter === t ? "active" : "") + '" onclick="setFilter(\'' + t + '\')">' + t + '</span>';
    });
    document.getElementById('filterTags').innerHTML = html;
}

function renderPaperList() {
    renderFilterTags();
    var search = document.getElementById("paperSearch").value.toLowerCase();
    var filtered = papers.filter(function(p) {
        var matchFilter = currentFilter === "all" || p.tags.indexOf(currentFilter) !== -1;
        var matchSearch = p.title.toLowerCase().indexOf(search) !== -1 || (p.arxiv && p.arxiv.toLowerCase().indexOf(search) !== -1);
        return matchFilter && matchSearch;
    });
    if (filtered.length === 0) {
        document.getElementById("paperList").innerHTML = '<div class="paper-empty">è®ºæ–‡åº“ä¸ºç©º<br>ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ è®ºæ–‡"å¼€å§‹</div>';
    } else {
        document.getElementById("paperList").innerHTML = filtered.map(function(p) {
            var status = p.parsed ? '<span style="color:var(--green)">å·²è§£æ</span>' : '<span style="color:var(--orange)">æœªè§£æ</span>';
            return '<div class="paper-item ' + (currentPaper && p.id === currentPaper.id ? 'active' : '') + '" onclick="selectPaper(' + p.id + ')">' +
                '<div class="paper-delete" onclick="event.stopPropagation();deletePaper(' + p.id + ')">x</div>' +
                '<div class="paper-title">' + p.title + '</div>' +
                '<div class="paper-meta">' + (p.arxiv ? 'arXiv: ' + p.arxiv : 'PDF') + ' | ' + p.date + '</div>' +
                '<div class="paper-tags">' + p.tags.map(function(t) { return '<span class="paper-tag">' + t + '</span>'; }).join('') + '</div>' +
                '<div class="paper-status">' + status + '</div>' +
                '</div>';
        }).join('');
    }
}

function selectPaper(id) {
    currentPaper = papers.find(function(p){return p.id===id;});
    renderPaperList();
    updateContent();
}

function updateContent() {
    if (!currentPaper) {
        document.getElementById("originalContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·å…ˆæ·»åŠ è®ºæ–‡å¹¶è§£æ</p>';
        document.getElementById("analysisTitle").innerHTML = '';
        return;
    }
    if (currentPaper.parsed && currentPaper.original) {
        var apiUrl = null || 'http://192.168.3.24:5001';
        var content = currentPaper.original.replace(/\/api\/images\//g, apiUrl + '/api/images/');
        document.getElementById("originalContent").innerHTML = content;
        renderKaTeX();
        if (currentPaper.translated) {
            var translated = currentPaper.translated.replace(/\/api\/images\//g, apiUrl + '/api/images/');
            document.getElementById("translatedContent").innerHTML = translated;
        renderKaTeX();
        } else {
            document.getElementById("translatedContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">ç‚¹å‡»"ç¿»è¯‘"è·å–ä¸­æ–‡ç¿»è¯‘</p>';
        }
    } else {
        document.getElementById("originalContent").innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">è¯·ç‚¹å‡»"è§£æ"æŒ‰é’®è§£æè®ºæ–‡</p>';
    }
    document.getElementById("analysisTitle").innerHTML = currentPaper.title;
    document.getElementById("analysisMeta").innerHTML = currentPaper.arxiv ? 'arXiv: ' + currentPaper.arxiv + ' | ' + currentPaper.date : currentPaper.date;
    document.getElementById("peerReviewTitle").innerHTML = currentPaper.title || '';
    document.getElementById("peerReviewMeta").innerHTML = currentPaper.arxiv ? 'arXiv: ' + currentPaper.arxiv + ' | ' + currentPaper.date : (currentPaper.date || '');
    
    // Display saved analysis
    if (currentPaper.analysis) {
        document.getElementById('analysisContent').innerHTML = '<div class="analysis-section">' + currentPaper.analysis + '</div>';
    }
    // Display saved peer review
    if (currentPaper.peerReview) {
        document.getElementById('peerReviewContent').innerHTML = '<div class="analysis-section">' + currentPaper.peerReview + '</div>';
    }
    
    // æ¸²æŸ“ KaTeX å…¬å¼
    renderKaTeX();
}

function renderKaTeX() {
    if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ],
            throwOnError: false
        });
    }
}

function parsePaper() {
    if (!currentPaper) return;
    var btn = document.getElementById('parseBtn');
    btn.innerHTML = '<span class="loading"></span> è§£æä¸­...';
    document.getElementById('originalContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æ­£åœ¨è§£æè®ºæ–‡ï¼Œè¯·ç¨å€™...</p>';
    
    var apiUrl = null || 'http://192.168.3.24:5001';
    
    // Check if it's a PDF file
    if (currentPaper.arxiv === 'PDF' && currentPaper.pdfUrl) {
        fetch(apiUrl + '/api/parsePdf', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: currentPaper.pdfUrl, filename: currentPaper.title + '.pdf'})
        })
        .then(function(res){return res.json();})
        .then(function(data){
            if(data.success && data.data && data.data.markdown){
                var markdown = data.data.markdown;
                currentPaper.title = data.data.title || currentPaper.title;
                currentPaper.abstract = data.data.abstract || '';
                
                btn.innerHTML = '<span class="loading"></span> æ ¼å¼è½¬æ¢ä¸­...';
                fetch(apiUrl + '/api/convert', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({markdown: markdown, title: currentPaper.title, uuid: currentPaper.uuid})
                })
                .then(function(r2){return r2.json();})
                .then(function(d2){
                    if(d2.success && d2.text){
                        currentPaper.original = d2.text;
                        currentPaper.parsed = true;
                        savePapers();
                        var apiUrl = null || 'http://192.168.3.24:5001';
                        var content = d2.text.replace(/\/api\/images\//g, apiUrl + '/api/images/');
                        document.getElementById('originalContent').innerHTML = content;
                        renderKaTeX();
                        document.getElementById('analysisTitle').innerHTML = currentPaper.title;
                    } else {
                        alert('æ ¼å¼è½¬æ¢å¤±è´¥: ' + (d2.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                    btn.innerHTML = 'è§£æ';
                    renderPaperList();
                })
                .catch(function(e2){alert('ç½‘ç»œé”™è¯¯: ' + e2.message);btn.innerHTML='è§£æ';});
            } else {
                alert('è§£æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                btn.innerHTML = 'è§£æ';
            }
        })
        .catch(function(e){alert('ç½‘ç»œé”™è¯¯: ' + e.message);btn.innerHTML='è§£æ';});
        return;
    }
    
    // Regular arXiv parsing
    var fallbackUrls = ['http://192.168.3.24:5001', 'http://127.0.0.1:5001'];
    var payload = {
        sourceType: 'arxiv',
        source: currentPaper.arxiv,
        uuid: currentPaper.uuid
    };
    
    fetch(apiUrl + '/api/parse', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(function(res){return res.json();})
    .then(function(data){
        if(data.success && data.data && data.data.markdown){
            var markdown = data.data.markdown;
            currentPaper.title = data.data.title || currentPaper.title;
            currentPaper.abstract = data.data.abstract || '';
            
            // Step 2: Convert to HTML with MiniMax
            btn.innerHTML = '<span class="loading"></span> æ ¼å¼è½¬æ¢ä¸­...';
            fetch(apiUrl + '/api/convert', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({markdown: markdown, title: currentPaper.title, uuid: currentPaper.uuid})
            })
            .then(function(r){return r.json();})
            .then(function(d){
                if(d.success && d.text){
                    currentPaper.original = d.text;
                    currentPaper.parsed = true;
                    savePapers();
                    var apiUrl = null || 'http://192.168.3.24:5001';
                    var content = d.text.replace(/\/api\/images\//g, apiUrl + '/api/images/');
                    document.getElementById('originalContent').innerHTML = content;
                    renderKaTeX();
                    document.getElementById('analysisTitle').innerHTML = currentPaper.title;
                } else {
                    alert('æ ¼å¼è½¬æ¢å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
                    document.getElementById('originalContent').innerHTML = '<p style="color:var(--text-muted)">æ ¼å¼è½¬æ¢å¤±è´¥</p>';
                }
                btn.innerHTML = 'è§£æ';
                renderPaperList();
            })
            .catch(function(e){
                alert('ç½‘ç»œé”™è¯¯: ' + e.message);
                btn.innerHTML = 'è§£æ';
            });
        } else {
            alert('è§£æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            document.getElementById('originalContent').innerHTML = '<p style="color:var(--text-muted)">è§£æå¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            btn.innerHTML = 'è§£æ';
            renderPaperList();
        }
    })
    .catch(function(err){
        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
        btn.innerHTML = 'è§£æ';
    });
}

function convertMarkdownToHtml(markdown) {
    var html = markdown
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    return html;
}

function translatePaper() {
    if (!currentPaper || !currentPaper.parsed) { alert('è¯·å…ˆè§£æè®ºæ–‡'); return; }
    var btn = document.getElementById('translateBtn');
    btn.innerHTML = '<span class="loading"></span> ç¿»è¯‘ä¸­...';
    document.getElementById('translatedContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æ­£åœ¨ç¿»è¯‘è®ºæ–‡ï¼Œè¯·ç¨å€™...</p>';
    
    var apiUrl = null || 'http://192.168.3.24:5001';
    // Fallback URLs
    var fallbackUrls = ['http://192.168.3.24:5001', 'http://127.0.0.1:5001'];
    var htmlContent = currentPaper.original;
    
    fetch(apiUrl + '/api/translate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({text: htmlContent, title: currentPaper.title})
    })
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success && d.text){
            currentPaper.translated = d.text;
            currentPaper.abstract = currentPaper.abstract || '';
            savePapers();
            var apiUrl = null || 'http://192.168.3.24:5001';
            var translated = d.text.replace(/\/api\/images\//g, apiUrl + '/api/images/');
            document.getElementById('translatedContent').innerHTML = translated;
            renderKaTeX();
        } else {
            alert('ç¿»è¯‘å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
            document.getElementById('translatedContent').innerHTML = '<p style="color:var(--text-muted)">ç¿»è¯‘å¤±è´¥</p>';
        }
        btn.innerHTML = 'ç¿»è¯‘';
    })
    .catch(function(e){
        alert('ç½‘ç»œé”™è¯¯: ' + e.message);
        btn.innerHTML = 'ç¿»è¯‘';
    });
}

function deletePaper(id) {
    if(confirm("ç¡®å®šåˆ é™¤è¿™ç¯‡è®ºæ–‡ï¼Ÿ")) {
        var apiUrl = 'http://192.168.3.24:5001';
        // è°ƒç”¨åç«¯ DELETE API
        fetch(apiUrl + '/api/papers/' + id, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function(d) {
                console.log('åˆ é™¤ç»“æœ:', d);
            })
            .catch(function(e) {
                console.error('åˆ é™¤å¤±è´¥:', e);
            });
        
        papers = papers.filter(function(p){return p.id!==id;});
        currentPaper = papers.length > 0 ? papers[0] : null;
        renderPaperList();
        updateContent();
    }
}

function clearAllPapers() {
    if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®ºæ–‡ï¼Ÿ")) {
        papers = [];
        currentPaper = null;
        savePapers();
        renderPaperList();
        updateContent();
    }
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-tag').forEach(function(t){t.classList.remove('active');});
    event.target.classList.add('active');
    renderPaperList();
}

function switchMode(mode) {
    document.querySelectorAll('.mode-tab').forEach(function(t){t.classList.remove('active');});
    event.target.classList.add('active');
    document.getElementById('readingMode').style.display = mode === 'reading' ? 'block' : 'none';
    document.getElementById('analysisMode').style.display = mode === 'analysis' ? 'block' : 'none';
    document.getElementById('peerReviewMode').style.display = mode === 'peerReview' ? 'block' : 'none';
    document.getElementById('semanticSearchMode').style.display = mode === 'semanticSearch' ? 'block' : 'none';
    document.getElementById('hotPapersMode').style.display = mode === 'hotPapers' ? 'block' : 'none';
    if (mode === 'hotPapers') {
        loadHotTopics();
        loadHotPapers();
        loadHotDates();
    }
}

function toggleSidebar(side) {
    var left = document.getElementById('sidebarLeft');
    var right = document.getElementById('sidebarRight');
    var tl = document.getElementById('toggleLeft');
    var tr = document.getElementById('toggleRight');
    var isMobile = window.innerWidth <= 1024;
    var sidebarWidth = isMobile ? 280 : 300;
    
    if(side === 'left'){
        var isCollapsed = left.classList.contains('collapsed');
        // å…ˆåˆ‡æ¢çŠ¶æ€
        left.classList.toggle('collapsed');
        tl.classList.toggle('collapsed');
        // æ ¹æ®æ–°çš„çŠ¶æ€è®¾ç½®ä½ç½®
        var newCollapsed = left.classList.contains('collapsed');
        tl.innerHTML = newCollapsed ? '&#8250;' : '&#8249;';
        if(isMobile) {
            // ç§»åŠ¨ç«¯æ ¹æ®collapsedçŠ¶æ€å†³å®šä½ç½®
            // collapsed(éšè—): left - translate = 0
            // æ˜¾ç¤º: left + 0 = 280px
            tl.style.transform = newCollapsed ? 'translateX(-' + sidebarWidth + 'px)' : 'translateX(0)';
            left.style.transform = newCollapsed ? 'translateX(-100%)' : 'translateX(0)';
        }
    } else {
        var isCollapsed = right.classList.contains('collapsed');
        right.classList.toggle('collapsed');
        tr.classList.toggle('collapsed');
        var newCollapsed = right.classList.contains('collapsed');
        tr.innerHTML = newCollapsed ? '&#8249;' : '&#8250;';
        if(isMobile) {
            // collapsed(éšè—): right + translate = 0
            // æ˜¾ç¤º: right + 0 = 280px
            tr.style.transform = newCollapsed ? 'translateX(' + sidebarWidth + 'px)' : 'translateX(0)';
            right.style.transform = newCollapsed ? 'translateX(100%)' : 'translateX(0)';
        }
    }
}

function showAddPaperModal(){
    document.getElementById('addPaperModal').classList.add('show');
    customTags = [];
    renderCustomTags();
}
function hideAddPaperModal(){
    document.getElementById('addPaperModal').classList.remove('show');
    selectedFiles = [];
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('pdfFileList').innerHTML = '';
    customTags = [];
}

function toggleInputMethod(){
    var t = document.getElementById('inputType').value;
    document.getElementById('singleArxivGroup').style.display = t === 'arxiv' ? 'block' : 'none';
    document.getElementById('batchArxivGroup').style.display = t === 'arxiv-batch' ? 'block' : 'none';
    document.getElementById('folderGroup').style.display = t === 'folder' ? 'block' : 'none';
    document.getElementById('pdfGroup').style.display = t === 'pdf' ? 'block' : 'none';
    document.getElementById('pdfUrlGroup').style.display = t === 'pdf-url' ? 'block' : 'none';
}

function handleFolderSelect(input){
    var files = input.files;
    selectedFiles = [];
    for(var i=0; i<files.length; i++) {
        if(files[i].name.toLowerCase().endsWith('.pdf')) {
            selectedFiles.push(files[i].name);
        pdfFiles.push(files[i]);
        }
    }
    renderFileList();
}

function handleFileSelect(input){
    var files = input.files;
    selectedFiles = [];
    for(var i=0; i<files.length; i++) {
        selectedFiles.push(files[i].name);
        pdfFiles.push(files[i]);
    }
    renderPdfFileList();
}

function renderFileList(){
    document.getElementById('fileList').innerHTML = selectedFiles.map(function(f,i){return '<div class="file-item"><span>' + f + '</span><span class="file-remove" onclick="selectedFiles.splice(' + i + ',1);renderFileList()">x</span></div>';}).join('');
}

function renderPdfFileList(){
    document.getElementById('pdfFileList').innerHTML = selectedFiles.map(function(f,i){return '<div class="file-item"><span>' + f + '</span><span class="file-remove" onclick="selectedFiles.splice(' + i + ',1);renderPdfFileList()">x</span></div>';}).join('');
}

function addCustomTag(){
    var input = document.getElementById('customTagInput');
    var tag = input.value.trim();
    if(tag && customTags.indexOf(tag) === -1) {
        customTags.push(tag);
        input.value = '';
        renderCustomTags();
    }
}

function removeCustomTag(index){
    customTags.splice(index, 1);
    renderCustomTags();
}

function renderCustomTags(){
    document.getElementById('customTags').innerHTML = customTags.map(function(t,i){return '<span class="custom-tag">' + t + '<span onclick="removeCustomTag(' + i + ')">x</span></span>';}).join('');
}

// ç”Ÿæˆè®ºæ–‡çš„å”¯ä¸€æ ‡è¯† uuid
function generateUuid(type, value) {
    if (type === 'arxiv') {
        return 'arxiv_' + value;
    } else if (type === 'pdf-url') {
        // ç”¨ URL çš„ hash ä½œä¸º uuid
        var hash = 0;
        for (var i = 0; i < value.length; i++) {
            var char = value.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'pdf_' + Math.abs(hash).toString(16);
    } else if (type === 'upload') {
        // ç”¨æ–‡ä»¶åçš„ hash ä½œä¸º uuid
        var hash = 0;
        for (var i = 0; i < value.length; i++) {
            var char = value.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'upload_' + Math.abs(hash).toString(16);
    }
    return 'unknown_' + Date.now();
}

function addPaper(){
    var type = document.getElementById('inputType').value;
    
    var newPapers = [];
    var newId = papers.length > 0 ? Math.max.apply(null, papers.map(function(p){return p.id;})) + 1 : 1;
    var allTags = customTags.slice();
    
    if(type === 'arxiv'){
        var id = document.getElementById('paperInput').value.trim();
        if(id) newPapers.push({id:newId,title:"è®ºæ–‡ " + id,arxiv:id,uuid:generateUuid('arxiv', id),date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",peerReview:"",parsed:false});
    } else if(type === 'arxiv-batch'){
        var ids = document.getElementById('batchInput').value.split('\n').filter(function(x){return x.trim();});
        ids.forEach(function(id,i){newPapers.push({id:newId+i,title:"è®ºæ–‡ " + id.trim(),arxiv:id.trim(),uuid:generateUuid('arxiv', id.trim()),date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",peerReview:"",parsed:false});});
    } else if(type === 'pdf' && pdfFiles && pdfFiles.length > 0){
        // Upload PDFs first
        var apiUrl = null || 'http://192.168.3.24:5001';
        var uploadPromises = pdfFiles.map(function(f, i) {
            var formData = new FormData();
            formData.append('file', f);
            return fetch(apiUrl + '/api/uploadPdf', {method:'POST', body:formData})
            .then(function(r){return r.json();})
            .then(function(d){return {index:i, filename:f.name, path:d.success?d.path:''};})
            .catch(function(){return {index:i, filename:f.name, path:''};});
        });
        
        Promise.all(uploadPromises).then(function(results){
            results.sort(function(a,b){return a.index - b.index;});
            results.forEach(function(r,i){
                newPapers.push({id:newId+i,title:r.filename.replace('.pdf',''),arxiv:"PDF",uuid:generateUuid('upload', r.filename),pdfUrl:r.path,date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",peerReview:"",parsed:false});
            });
            papers.unshift.apply(papers, newPapers);
            currentPaper = papers[0];
            savePapers();
            renderPaperList();
            updateContent();
            hideAddPaperModal();
            if(newPapers.length > 0) { selectPaper(newPapers[0].id); parsePaper(); }
        });
        return;
    } else if(type === 'folder'){
        selectedFiles.forEach(function(f,i){newPapers.push({id:newId+i,title:f.replace('.pdf',''),arxiv:"PDF",uuid:generateUuid('upload', f),date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",peerReview:"",parsed:false});});
    } else if(type === 'pdf-url'){
        var pdfUrl = document.getElementById('pdfUrlInput').value.trim();
        if(pdfUrl) {
            // Extract filename from URL
            var filename = pdfUrl.split('/').pop() || 'paper.pdf';
            newPapers.push({id:newId,title:filename.replace('.pdf',''),arxiv:"PDF",uuid:generateUuid('pdf-url', pdfUrl),pdfUrl:pdfUrl,date:new Date().toISOString().split('T')[0],tags:allTags,abstract:"",translated:"",original:"",analysis:"",peerReview:"",parsed:false});
        }
    }
    
    papers.unshift.apply(papers, newPapers);
    currentPaper = papers[0];
    savePapers();
    renderPaperList();
    updateContent();
    hideAddPaperModal();
    
    // è‡ªåŠ¨è§£æç¬¬ä¸€ç¯‡
    if(newPapers.length > 0) {
        selectPaper(newPapers[0].id);
        parsePaper();
    }
}

function parseMarkdown(text) {
    if (!text) return text;
    // è½¬ä¹‰ HTML æ ‡ç­¾
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // æ ‡é¢˜
    text = text.replace(/^### (.+)$/gm, '<h4 style="margin:12px 0 6px 0;font-size:14px;font-weight:600">$1</h4>');
    text = text.replace(/^## (.+)$/gm, '<h3 style="margin:14px 0 8px 0;font-size:16px;font-weight:600">$1</h3>');
    text = text.replace(/^# (.+)$/gm, '<h2 style="margin:16px 0 10px 0;font-size:18px;font-weight:600">$1</h2>');
    // åŠ ç²—
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // æ–œä½“
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // ä»£ç 
    text = text.replace(/`(.+?)`/g, '<code style="background:#eee;color:#333;padding:1px 4px;border-radius:3px">$1</code>');
    // æ— åºåˆ—è¡¨
    text = text.replace(/^- (.+)$/gm, '<li style="margin:4px 0">$1</li>');
    text = text.replace(/(<li[^>]*>.*<\/li>)\n?/g, '<ul style="margin:8px 0;padding-left:20px">$1</ul>');
    // æ•°å­—åˆ—è¡¨
    text = text.replace(/^\d+\. (.+)$/gm, '<li style="margin:4px 0">$1</li>');
    // æ¢è¡Œ
    text = text.replace(/\n/g, '<br>');
    return text;
}

function askQuestion(btn){document.getElementById('chatInput').value = btn.textContent;sendMessage();}
function sendMessage(){
    var input = document.getElementById('chatInput');
    var msg = input.value.trim();
    if(!msg) return;
    var m = document.getElementById('chatMessages');
    m.innerHTML += '<div class="chat-bubble user">' + msg + '</div><div class="chat-bubble">æ­£åœ¨åˆ†æ...</div>';
    m.scrollTop = m.scrollTop = m.scrollHeight;
    input.value = '';
    
    var apiUrl = 'http://192.168.3.24:5001';
    
    // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œå…ˆåˆ›å»º
    if(chatSessions.length === 0) {
        fetch(apiUrl + '/api/chat/sessions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title: 'æ–°å¯¹è¯', paper_id: currentPaper ? currentPaper.id : null})
        })
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                chatSessions.push(d.data);
                currentChatSession = d.data.uuid;
                renderChatTabs();
                sendToChatApi(currentChatSession, msg, apiUrl, m);
            } else {
                alert('åˆ›å»ºä¼šè¯å¤±è´¥');
            }
        })
        .catch(function(e){
            alert('ç½‘ç»œé”™è¯¯: ' + e.message);
        });
    } else {
        sendToChatApi(currentChatSession, msg, apiUrl, m);
    }
}

function sendToChatApi(sessionUuid, msg, apiUrl, m) {
    // è·å–è®ºæ–‡ä¸Šä¸‹æ–‡
    var context = '';
    if(currentPaper && currentPaper.original) {
        context = 'è®ºæ–‡æ ‡é¢˜: ' + (currentPaper.title || '') + '\n\nè®ºæ–‡å†…å®¹:\n' + currentPaper.original.substring(0, 196608);
    }
    
    fetch(apiUrl + '/api/chat/sessions/' + sessionUuid + '/messages', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({role: 'user', content: msg, context: context})
    })
    .then(function(r){return r.json();})
    .then(function(d){
        var bubbles = m.querySelectorAll('.chat-bubble');
        var lastBubble = bubbles[bubbles.length - 1];
        if(d.success && d.text){
            lastBubble.innerHTML = parseMarkdown(d.text);
        } else {
            lastBubble.innerHTML = 'å›ç­”å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯');
        }
        m.scrollTop = m.scrollHeight;
    })
    .catch(function(e){
        var bubbles = m.querySelectorAll('.chat-bubble');
        var lastBubble = bubbles[bubbles.length - 1];
        lastBubble.innerHTML = 'ç½‘ç»œé”™è¯¯: ' + e.message;
        m.scrollTop = m.scrollHeight;
    });
}

renderPaperList();
updateContent();

function showApiSettings(){
    var url = prompt("è¯·è¾“å…¥ API æœåŠ¡å™¨åœ°å€:", localStorage.getItem("apiUrl") || 'http://192.168.3.24:5001');
    if(url){
        // localStorage.setItem("apiUrl", url);
        alert("API å·²æ›´æ–°ä¸º: " + url);
    }
}

function toggleMobileSidebar(){
    var sidebar = document.getElementById('sidebarLeft');
    var overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

function mobileNav(tab){
    document.querySelectorAll('.mobile-item').forEach(function(el){el.classList.remove('active');});
    event.target.closest('.mobile-item').classList.add('active');
    
    var isMobile = window.innerWidth <= 1024;
    var left = document.getElementById('sidebarLeft');
    var right = document.getElementById('sidebarRight');
    
    if(tab === 1){
        // è®ºæ–‡ - æ˜¾ç¤º/éšè—å·¦ä¾§è®ºæ–‡åº“
        if(isMobile) {
            left.classList.toggle('collapsed');
            left.style.transform = left.classList.contains('collapsed') ? 'translateX(-100%)' : 'translateX(0)';
            // å…³é—­å³ä¾§
            right.classList.add('collapsed');
            right.style.transform = 'translateX(100%)';
        }
        switchMode('reading');
    } else if(tab === 2){
        // é˜…è¯»
        switchMode('reading');
        if(isMobile) {
            left.classList.add('collapsed');
            right.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
            right.style.transform = 'translateX(100%)';
        }
    } else if(tab === 3){
        // åˆ†æ
        switchMode('analysis');
        if(isMobile) {
            left.classList.add('collapsed');
            right.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
            right.style.transform = 'translateX(100%)';
        }
    } else if(tab === 4){
        // è¯„å®¡
        switchMode('peerReview');
        if(isMobile) {
            left.classList.add('collapsed');
            right.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
            right.style.transform = 'translateX(100%)';
        }
    } else if(tab === 5){
        // æ£€ç´¢
        switchMode('semanticSearch');
        if(isMobile) {
            left.classList.add('collapsed');
            right.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
            right.style.transform = 'translateX(100%)';
        }
    } else if(tab === 6){
        // çƒ­ç‚¹
        switchMode('hotPapers');
        if(isMobile) {
            left.classList.add('collapsed');
            right.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
            right.style.transform = 'translateX(100%)';
        }
    } else if(tab === 7){
        // å¯¹è¯ - æ˜¾ç¤º/éšè—å³ä¾§é—®ç­”æ 
        if(isMobile) {
            right.classList.toggle('collapsed');
            right.style.transform = right.classList.contains('collapsed') ? 'translateX(100%)' : 'translateX(0)';
            // å…³é—­å·¦ä¾§
            left.classList.add('collapsed');
            left.style.transform = 'translateX(-100%)';
        }
    }
}


function generatePeerReview() {
    if (!currentPaper || !currentPaper.parsed) { alert('è¯·å…ˆè§£æè®ºæ–‡'); return; }
    var btn = document.getElementById('peerReviewBtn');
    btn.innerHTML = '<span class="loading"></span> è¯„å®¡ä¸­...';
    btn.disabled = true;
    document.getElementById('peerReviewContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æ­£åœ¨ç”ŸæˆåŒè¡Œè¯„å®¡ï¼Œè¯·ç¨å€™...</p>';
    
    var apiUrl = null || 'http://192.168.3.24:5001';
    
    // First get peer review - æˆªæ–­å†…å®¹ä»¥é¿å…ä¸Šä¸‹æ–‡æº¢å‡º
    var content = currentPaper.original ? currentPaper.original.substring(0, 196608) : '';
    fetch(apiUrl + '/api/peerReview', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:currentPaper.title, abstract:currentPaper.abstract, content: content})})
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success && d.text){
            // Then convert to HTML
            btn.innerHTML = '<span class="loading"></span> æ ¼å¼è½¬æ¢ä¸­...';
            fetch(apiUrl + '/api/convert', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({markdown: d.text, title: 'åŒè¡Œè¯„å®¡', uuid: currentPaper.uuid})
            })
            .then(function(r2){return r2.json();})
            .then(function(d2){
                if(d2.success && d2.text){
                    currentPaper.peerReview = d2.text;
                    savePapers();
                    document.getElementById('peerReviewContent').innerHTML = '<div class="analysis-section">'+d2.text+'</div>';
                    renderKaTeX();
                } else {
                    currentPaper.peerReview = d.text;
                    savePapers();
                    document.getElementById('peerReviewContent').innerHTML = '<div class="analysis-section">'+d.text+'</div>';
                }
                btn.innerHTML = 'ç”ŸæˆåŒè¡Œè¯„å®¡'; btn.disabled = false;
            })
            .catch(function(e2){
                currentPaper.peerReview = d.text;
                savePapers();
                document.getElementById('peerReviewContent').innerHTML = '<div class="analysis-section">'+d.text+'</div>';
                btn.innerHTML = 'ç”ŸæˆåŒè¡Œè¯„å®¡'; btn.disabled = false;
            });
        } else {
            alert('è¯„å®¡å¤±è´¥: '+(d.error||'æœªçŸ¥'));
            btn.innerHTML = 'ç”ŸæˆåŒè¡Œè¯„å®¡'; btn.disabled = false;
        }
    })
    .catch(function(e){alert('ç½‘ç»œé”™è¯¯: '+e.message);btn.innerHTML='ç”ŸæˆåŒè¡Œè¯„å®¡';btn.disabled=false;});
}

// çƒ­ç‚¹æ¨èç›¸å…³å‡½æ•°
function loadHotTopics() {
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/hot/topics')
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                var html = '';
                d.data.forEach(function(t) {
                    html += '<span style="padding:4px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;font-size:12px;cursor:pointer;opacity:' + (t.enabled ? '1' : '0.5') + '" onclick="toggleHotTopic(' + t.id + ')">' + t.name + '</span>';
                });
                html += '<span style="padding:4px 10px;background:var(--accent);color:#fff;border-radius:4px;font-size:12px;cursor:pointer" onclick="addHotTopic()">+ æ·»åŠ </span>';
                document.getElementById('hotTopicsList').innerHTML = html;
            }
        })
        .catch(function(e){console.error('åŠ è½½è¯é¢˜å¤±è´¥:', e);});
}

function toggleHotTopic(id) {
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/hot/topics/' + id + '/toggle', {method:'POST'})
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success) loadHotTopics();
        })
        .catch(function(e){console.error('åˆ‡æ¢è¯é¢˜å¤±è´¥:', e);});
}

function addHotTopic() {
    var name = prompt('è¯·è¾“å…¥æ–°è¯é¢˜åç§°:');
    if(!name) return;
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/hot/topics', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name: name})
    })
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success) loadHotTopics();
        else alert('æ·»åŠ å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
    })
    .catch(function(e){alert('ç½‘ç»œé”™è¯¯: ' + e.message);});
}

function loadHotPapers() {
    var apiUrl = 'http://192.168.3.24:5001';
    var dateSelect = document.getElementById('hotDateSelect');
    var date = dateSelect.value;
    // é»˜è®¤å½“å¤©
    if (!date) {
        var today = new Date().toISOString().split('T')[0];
        dateSelect.value = today;
        date = today;
    }
    var url = apiUrl + '/api/hot/papers';
    if(date) url += '?date=' + date;
    
    document.getElementById('hotPapersStats').innerHTML = 'åŠ è½½ä¸­...';
    fetch(url)
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                document.getElementById('hotPapersStats').innerHTML = 'å…± ' + d.data.length + ' ç¯‡è®ºæ–‡';
                var html = '';
                d.data.forEach(function(p) {
                    var topics = p.topics ? JSON.parse(p.topics).join(', ') : '';
                    html += '<div style="background:var(--bg-secondary);padding:16px;border-radius:8px">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">';
                    html += '<span style="font-size:12px;color:var(--accent);background:rgba(155,126,217,0.2);padding:2px 8px;border-radius:4px">' + p.source + '</span>';
                    html += '<span style="font-size:11px;color:var(--text-muted)">' + p.date + '</span>';
                    html += '</div>';
                    html += '<h3 style="margin:8px 0;font-size:14px;font-weight:600">' + (p.title || 'æ— æ ‡é¢˜') + '</h3>';
                    if(p.chinese_summary) {
                        html += '<p style="font-size:13px;color:#10b981;margin:8px 0;font-weight:500;background:rgba(16,185,129,0.1);padding:8px;border-radius:4px;border-left:3px solid #10b981">' + p.chinese_summary + '</p>';
                    }
                    html += '<p style="font-size:12px;color:var(--text-muted);margin:8px 0">' + (p.authors || '') + '</p>';
                    if(topics) html += '<p style="font-size:11px;color:var(--accent);margin:8px 0">è¯é¢˜: ' + topics + '</p>';
                    html += '<p style="font-size:12px;color:var(--text-secondary);margin:8px 0">' + (p.abstract || '') + '</p>';
                    if(p.arxiv_id) {
                        html += '<button style="margin-top:8px;padding:6px 12px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px" onclick="importHotPaper(\'' + p.arxiv_id + '\')">å¯¼å…¥è®ºæ–‡åº“</button>';
                    }
                    html += '</div>';
                });
                document.getElementById('hotPapersList').innerHTML = html || '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æš‚æ— çƒ­ç‚¹è®ºæ–‡</p>';
            }
        })
        .catch(function(e){console.error('åŠ è½½çƒ­ç‚¹è®ºæ–‡å¤±è´¥:', e);});
}

function fetchHotPapers() {
    document.getElementById('hotPapersStats').innerHTML = 'æ­£åœ¨æŠ“å–çƒ­ç‚¹è®ºæ–‡...';
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/hot/fetch', {method:'POST'})
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success) {
                document.getElementById('hotPapersStats').innerHTML = 'æ­£åœ¨ç”ŸæˆAIæ‘˜è¦...';
                // ç­‰å¾…è¶³å¤Ÿæ—¶é—´è®©AIç”Ÿæˆå®Œæˆ
                setTimeout(function(){
                    loadHotPapers();
                }, 12000);
            } else {
                alert('æŠ“å–å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(function(e){alert('ç½‘ç»œé”™è¯¯: ' + e.message);});
}

function importHotPaper(arxivId) {
    var apiUrl = 'http://192.168.3.24:5001';
    // æŸ¥æ‰¾è®ºæ–‡ä¿¡æ¯
    fetch(apiUrl + '/api/hot/papers?arxiv_id=' + arxivId)
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data && d.data[0]) {
                var paper = d.data[0];
                fetch(apiUrl + '/api/hot/import', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({arxiv_id: arxivId, title: paper.title, abstract: paper.abstract})
                })
                .then(function(r2){return r2.json();})
                .then(function(d2){
                    if(d2.success) {
                        alert('è®ºæ–‡å·²å¯¼å…¥: ' + paper.title);
                        initPapers(); // åˆ·æ–°è®ºæ–‡åˆ—è¡¨
                    } else {
                        alert('å¯¼å…¥å¤±è´¥: ' + (d2.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(function(e){alert('ç½‘ç»œé”™è¯¯: ' + e.message);});
            }
        })
        .catch(function(e){alert('ç½‘ç»œé”™è¯¯: ' + e.message);});
}

function loadHotDates() {
    var apiUrl = 'http://192.168.3.24:5001';
    fetch(apiUrl + '/api/hot/dates')
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.data) {
                var today = new Date().toISOString().split('T')[0];
                // å¦‚æœæœ‰å½“å¤©æ—¥æœŸï¼Œé»˜è®¤é€‰ä¸­
                var hasToday = d.data.includes(today);
                var html = hasToday ? '' : '<option value="">é€‰æ‹©æ—¥æœŸ</option>';
                d.data.forEach(function(date) {
                    var selected = date === today ? ' selected' : '';
                    html += '<option value="' + date + '"' + selected + '>' + date + '</option>';
                });
                if (!hasToday) {
                    html += '<option value="' + today + '">' + today + '</option>';
                }
                document.getElementById('hotDateSelect').innerHTML = html;
            }
        })
        .catch(function(e){console.error('åŠ è½½æ—¥æœŸå¤±è´¥:', e);});
}

function doSemanticSearch() {
    var query = document.getElementById('searchInput').value.trim();
    if (!query) { alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯'); return; }
    document.getElementById('searchStats').innerHTML = 'æ­£åœ¨æœç´¢...';
    document.getElementById('searchResults').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æœç´¢ä¸­ï¼Œè¯·ç¨å€™...</p>';
    var apiUrl = (null || 'http://192.168.3.24:5001') + '/api/semanticSearch';
    fetch(apiUrl, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:query, sort:document.getElementById('sortBy').value})})
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success && d.papers){
            var papers = d.papers;
            document.getElementById('searchStats').innerHTML = 'æ‰¾åˆ° ' + papers.length + ' ç¯‡ç›¸å…³è®ºæ–‡';
            if(papers.length === 0) {
                document.getElementById('searchResults').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æœªæ‰¾åˆ°ç›¸å…³è®ºæ–‡</p>';
                return;
            }
            var html = papers.map(function(p){
                var sim = p.similarity ? p.similarity + '%' : '';
                var chineseSummaryHtml = p.chinese_summary ? '<p style="font-size:13px;color:#10b981;margin:8px 0;font-weight:500;background:rgba(16,185,129,0.1);padding:8px;border-radius:4px;border-left:3px solid #10b981">'+p.chinese_summary+'</p>' : '';
                return '<div style="background:var(--bg-secondary);border-radius:8px;padding:16px;cursor:pointer">' +
                    '<div style="font-size:14px;font-weight:600;margin-bottom:8px">'+p.title+'</div>' +
                    chineseSummaryHtml +
                    '<div style="font-size:12px;color:var(--text-muted)">'+(p.year||'')+' | '+(p.citationCount||0)+' citations'+(sim ? ' | ç›¸ä¼¼åº¦: '+sim : '')+'</div>' +
                    '<div style="font-size:12px;color:var(--text-secondary);margin-top:8px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical">'+(p.abstract||'')+'</div>' +
                    '<button style="margin-top:8px;padding:6px 12px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px" onclick="event.stopPropagation();importSearchPaper(\''+p.paperId+'\',\''+encodeURIComponent(p.title)+'\')">å¯¼å…¥è®ºæ–‡åº“</button>' +
                    '</div>';
            }).join('');
            document.getElementById('searchResults').innerHTML = html;
        } else {
            document.getElementById('searchStats').innerHTML = 'æœç´¢å¤±è´¥';
            document.getElementById('searchResults').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æœç´¢å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯')+'</p>';
        }
    })
    .catch(function(e){
        document.getElementById('searchStats').innerHTML = 'ç½‘ç»œé”™è¯¯';
        document.getElementById('searchResults').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">ç½‘ç»œé”™è¯¯: '+e.message+'</p>';
    });
}

function importSearchPaper(paperId, title, hasArxiv) {
    var papersList = papers.slice();
    var paperTitle = title ? decodeURIComponent(title) : 'è®ºæ–‡ ' + paperId;
    var apiUrl = (null || 'http://192.168.3.24:5001');
    
    // Check if paperId is valid arXiv format
    var isValidArxiv = paperId && paperId.match(/^\d{4}\.\d{4,5}$/);
    
    // If no valid arXiv ID, search for it
    if (!isValidArxiv) {
        document.getElementById('searchStats').innerHTML = 'æ­£åœ¨æœç´¢arXiv ID...';
        fetch(apiUrl + '/api/searchArxiv', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({title: paperTitle})
        })
        .then(function(r){return r.json();})
        .then(function(d){
            if(d.success && d.arxivId && d.arxivId.match(/^\d{4}\.\d{4,5}$/)) {
                doImport(papersList, d.arxivId, paperTitle);
            } else {
                alert('æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„arXiv IDï¼Œè¯¥è®ºæ–‡å¯èƒ½æ²¡æœ‰arXivç‰ˆæœ¬');
            }
        })
        .catch(function(){
            alert('æœç´¢arXiv IDå¤±è´¥');
        });
    } else {
        // Valid arXiv ID, import directly
        doImport(papersList, paperId, paperTitle);
    }
}

function doImport(papersList, arxivId, paperTitle) {
    // Check for duplicates
    var isDuplicate = papersList.some(function(p) { return p.arxiv === arxivId; });
    if (isDuplicate) {
        alert('è®ºæ–‡å·²å­˜åœ¨: ' + paperTitle);
        return;
    }
    
    var newId = papersList.length > 0 ? Math.max.apply(null, papersList.map(function(p){return p.id;})) + 1 : 1;
    var uuid = generateUuid('arxiv', arxivId);
    papersList.unshift({
        id: newId,
        uuid: uuid,
        title: paperTitle,
        arxiv: arxivId,
        date: new Date().toISOString().split('T')[0],
        tags: [],
        abstract: '',
        translated: '',
        original: '',
        analysis: '',
        peerReview: '',
        parsed: false
    });
    // localStorage.setItem('paperLibrary', JSON.stringify(papersList));
    papers = papersList;
    alert('è®ºæ–‡å·²æ·»åŠ åˆ°è®ºæ–‡åº“: ' + paperTitle + ' (arXiv: ' + arxivId + ')');
    document.querySelectorAll('.nav-tab')[0].click();
    renderPaperList();
    savePapers();
}


function generateAnalysis() {
    if (!currentPaper || !currentPaper.parsed) { alert('è¯·å…ˆè§£æè®ºæ–‡'); return; }
    var btn = document.getElementById('analyzeBtn');
    btn.innerHTML = '<span class="loading"></span> åˆ†æä¸­...';
    btn.disabled = true;
    document.getElementById('analysisContent').innerHTML = '<p style="color:var(--text-muted);text-align:center;margin-top:40px">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼Œè¯·ç¨å€™...</p>';
    
    var apiUrl = null || 'http://192.168.3.24:5001';
    // Fallback URLs
    var fallbackUrls = ['http://192.168.3.24:5001', 'http://127.0.0.1:5001'];
    
    // First get analysis - æˆªæ–­å†…å®¹ä»¥é¿å…ä¸Šä¸‹æ–‡æº¢å‡º
    var content = currentPaper.original ? currentPaper.original.substring(0, 196608) : '';
    fetch(apiUrl + '/api/analyze', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:currentPaper.title, abstract:currentPaper.abstract, content: content})})
    .then(function(r){return r.json();})
    .then(function(d){
        if(d.success && d.text){
            // Then convert to HTML
            btn.innerHTML = '<span class="loading"></span> æ ¼å¼è½¬æ¢ä¸­...';
            fetch(apiUrl + '/api/convert', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({markdown: d.text, title: 'åˆ†ææŠ¥å‘Š', uuid: currentPaper.uuid})
            })
            .then(function(r2){return r2.json();})
            .then(function(d2){
                if(d2.success && d2.text){
                    document.getElementById('analysisContent').innerHTML = '<div class="analysis-section">'+d2.text+'</div>';
                    renderKaTeX();
                    currentPaper.analysis = d2.text;
                    savePapers();
                } else {
                    document.getElementById('analysisContent').innerHTML = '<div class="analysis-section">'+d.text+'</div>';
                }
                btn.innerHTML = 'ç”Ÿæˆåˆ†ææŠ¥å‘Š'; btn.disabled = false;
            })
            .catch(function(e2){
                document.getElementById('analysisContent').innerHTML = '<div class="analysis-section">'+d.text+'</div>';
                btn.innerHTML = 'ç”Ÿæˆåˆ†ææŠ¥å‘Š'; btn.disabled = false;
            });
        } else {
            alert('åˆ†æå¤±è´¥: '+(d.error||'æœªçŸ¥'));
            btn.innerHTML = 'ç”Ÿæˆåˆ†ææŠ¥å‘Š'; btn.disabled = false;
        }
    })
    .catch(function(e){alert('ç½‘ç»œé”™è¯¯: '+e.message);btn.innerHTML='ç”Ÿæˆåˆ†ææŠ¥å‘Š';btn.disabled=false;});
}


function downloadPaper() {
    if (!currentPaper) { alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡è®ºæ–‡'); return; }
    var data = {
        title: currentPaper.title,
        arxiv: currentPaper.arxiv,
        date: currentPaper.date,
        tags: currentPaper.tags,
        abstract: currentPaper.abstract,
        original: currentPaper.original,
        translated: currentPaper.translated,
        analysis: currentPaper.analysis,
        peerReview: currentPaper.peerReview,
        exportedAt: new Date().toISOString()
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (currentPaper.title || currentPaper.arxiv || 'paper') + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
}

function hideImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function importPaper() {
    var file = document.getElementById('importFile').files[0];
    if (!file) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            var papersList = papers.slice();
            var newId = papersList.length > 0 ? Math.max.apply(null, papersList.map(function(p){return p.id;})) + 1 : 1;
            papersList.unshift({
                id: newId,
                title: data.title || 'æœªçŸ¥è®ºæ–‡',
                arxiv: data.arxiv || '',
                date: data.date || new Date().toISOString().split('T')[0],
                tags: data.tags || [],
                abstract: data.abstract || '',
                original: data.original || '',
                translated: data.translated || '',
                analysis: data.analysis || '',
                peerReview: data.peerReview || '',
                parsed: !!data.original
            });
            // localStorage.setItem('paperLibrary', JSON.stringify(papersList));
            papers = papersList;
            currentPaper = papers[0];
            renderPaperList();
            updateContent();
            hideImportModal();
            alert('å¯¼å…¥æˆåŠŸ: ' + data.title);
        } catch(err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); }
    };
    reader.readAsText(file);
}
</script>
<script>document.addEventListener("DOMContentLoaded", function() {
    // ä» SQLite åŠ è½½è®ºæ–‡
    initPapers();
    
    // åˆå§‹åŒ–å¯¹è¯
    initChat();
    
    if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ],
            throwOnError: false
        });
    }
});

function downloadPaper() {
    if (!currentPaper) { alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡è®ºæ–‡'); return; }
    var data = {
        title: currentPaper.title,
        arxiv: currentPaper.arxiv,
        date: currentPaper.date,
        tags: currentPaper.tags,
        abstract: currentPaper.abstract,
        original: currentPaper.original,
        translated: currentPaper.translated,
        analysis: currentPaper.analysis,
        peerReview: currentPaper.peerReview,
        exportedAt: new Date().toISOString()
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (currentPaper.title || currentPaper.arxiv || 'paper') + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
}

function hideImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function importPaper() {
    var file = document.getElementById('importFile').files[0];
    if (!file) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            var papersList = papers.slice();
            var newId = papersList.length > 0 ? Math.max.apply(null, papersList.map(function(p){return p.id;})) + 1 : 1;
            papersList.unshift({
                id: newId,
                title: data.title || 'æœªçŸ¥è®ºæ–‡',
                arxiv: data.arxiv || '',
                date: data.date || new Date().toISOString().split('T')[0],
                tags: data.tags || [],
                abstract: data.abstract || '',
                original: data.original || '',
                translated: data.translated || '',
                analysis: data.analysis || '',
                peerReview: data.peerReview || '',
                parsed: !!data.original
            });
            // localStorage.setItem('paperLibrary', JSON.stringify(papersList));
            papers = papersList;
            currentPaper = papers[0];
            renderPaperList();
            updateContent();
            hideImportModal();
            alert('å¯¼å…¥æˆåŠŸ: ' + data.title);
        } catch(err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); }
    };
    reader.readAsText(file);
}
</script>

<div class="modal-overlay" id="importModal">
<div class="modal"><div class="modal-header"><span class="modal-title">å¯¼å…¥è®ºæ–‡</span><span class="modal-close" onclick="hideImportModal()">x</span></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">é€‰æ‹©å¯¼å…¥æ–‡ä»¶ (.json)</label><label class="form-file"><input type="file" id="importFile" accept=".json"><span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></label></div>
<div class="file-list" id="importList"></div>
</div><div class="modal-footer"><button class="paper-action2" onclick="importPaper()">å¯¼å…¥</button></div></div></div>

<script>
window.addEventListener('resize', function() {
    var right = document.getElementById('sidebarRight');
    var left = document.getElementById('sidebarLeft');
    var tl = document.getElementById('toggleLeft');
    var tr = document.getElementById('toggleRight');
    if (window.innerWidth > 1024) {
        // å®½å±æ¨¡å¼ä¸‹é‡ç½®transform
        right.style.transform = '';
        left.style.transform = '';
        tl.style.transform = '';
        tr.style.transform = '';
    }
});

// åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¾§æ éšè—
(function() {
    if (window.innerWidth <= 1024) {
        var left = document.getElementById('sidebarLeft');
        var right = document.getElementById('sidebarRight');
        var tl = document.getElementById('toggleLeft');
        var tr = document.getElementById('toggleRight');
        // ä¾§æ é»˜è®¤éšè—
        left.style.transform = 'translateX(-100%)';
        right.style.transform = 'translateX(100%)';
        left.classList.add('collapsed');
        right.classList.add('collapsed');
        // toggleæŒ‰é’®åˆå§‹ä½ç½®ï¼šåœ¨ä¾§æ å†…ä¾§(ä½ç½®0)ï¼Œé€šè¿‡translateXç§»åŠ¨
        tl.style.transform = 'translateX(-280px)';
        tr.style.transform = 'translateX(280px)';
    }
})();
</script>
</body>
</html>
